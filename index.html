<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليلك - تطبيق السياحة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script type="module">
        // Make modal functions globally accessible FIRST (for non-Swal modals)
        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex'; // Use flex for centering
                modal.style.opacity = '1';
                document.body.classList.add('overflow-hidden');
                console.log(`Modal '${modalId}' opened.`);
            } else {
                console.error(`Modal with ID '${modalId}' not found for opening.`);
            }
        }
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = ''; // Reset display
                modal.style.opacity = '';
                modal.style.zIndex = '';
                document.body.classList.remove('overflow-hidden');
                console.log(`Modal '${modalId}' closed.`);
            } else {
                console.error(`Modal with ID '${modalId}' not found for closing.`);
            }
        }

        // Firebase SDKs
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy, limit, GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD5BSCAonqJm9Ksi0ZVPKCQ-k33KiOc1O8", // Replace with your actual API key if needed
          authDomain: "dalelk-dc188.firebaseapp.com",
          projectId: "dalelk-dc188",
          storageBucket: "dalelk-dc188.appspot.com",
          messagingSenderId: "924665918120",
          appId: "1:924665918120:web:584cbfb578b3a4d06a489d",
          measurementId: "G-N42GFYY06Q"
        };
        console.log("Firebase Config:", firebaseConfig);

        const appId = firebaseConfig.projectId; // Using projectId as appId for path construction
        console.log("App ID for Firestore/Storage paths:", appId);

        let app, auth, db, analytics;
        let userId = null;
        let userRole = null; // 'investor', 'visitor', or null
        let isAuthDataLoaded = false; // Flag to prevent multiple data loads on auth state change
        let initialAuthCheckCompleted = false; // To manage initial anonymous sign-in
        let establishmentsListener = null; // To unsubscribe from previous listener
        let mainMap = null;
        let userMarker = null;
        let establishmentMarkers = []; // To keep track of markers on the main map

        window.selectedCoordsForNewEstablishment = null; // To store coords from map picker
        window.tempEstablishmentData = {}; // To store form data temporarily when opening map picker

        // --- Language and Translation ---
        const supportedLanguages = [
            { code: 'ar', name: 'العربية', dir: 'rtl' },
            { code: 'en', name: 'English', dir: 'ltr' },
            { code: 'es', name: 'Español', dir: 'ltr' },
            { code: 'de', name: 'Deutsch', dir: 'ltr' },
            { code: 'tr', name: 'Türkçe', dir: 'ltr' }
        ];

        let currentLanguage = localStorage.getItem('selectedLanguage') || 'ar'; // Default to Arabic

        const translations = {
            // Keys for dynamic content like categories/governorates
            "all": { ar: "الكل", en: "All", es: "Todos", de: "Alle", tr: "Tümü" },
            "restaurant": { ar: "مطعم", en: "Restaurant", es: "Restaurante", de: "Restaurant", tr: "Restoran" },
            "hotel": { ar: "فندق", en: "Hotel", es: "Hotel", de: "Hotel", tr: "Otel" },
            "cafe": { ar: "مقهى", en: "Cafe", es: "Cafetería", de: "Café", tr: "Kafe" },
            "beach": { ar: "شاطئ", en: "Beach", es: "Playa", de: "Strand", tr: "Plaj" },
            "mountain": { ar: "جبل", en: "Mountain", es: "Montaña", de: "Berg", tr: "Dağ" },
            "forest": { ar: "غابة", en: "Forest", es: "Bosque", de: "Wald", tr: "Orman" },
            "museum": { ar: "متحف", en: "Museum", es: "Museo", de: "Museum", tr: "Müze" },
            "pool": { ar: "مسبح", en: "Pool", es: "Piscina", de: "Schwimmbad", tr: "Havuz" },
            "river": { ar: "نهر", en: "River", es: "Río", de: "Fluss", tr: "Nehir" },
            "archaeological_site": { ar: "معلم أثري", en: "Archaeological Site", es: "Sitio Arqueológico", de: "Archäologische Stätte", tr: "Arkeolojik Alan" },
            "park": { ar: "منتزه", en: "Park", es: "Parque", de: "Park", tr: "Park" },
            "popular_market": { ar: "سوق شعبي", en: "Popular Market", es: "Mercado Popular", de: "Beliebter Markt", tr: "Halk Pazarı" },
            "other": { ar: "أخرى", en: "Other", es: "Otro", de: "Andere", tr: "Diğer" },
            
            "damascus": { ar: "دمشق", en: "Damascus", es: "Damasco", de: "Damaskus", tr: "Şam" },
            "rif_dimashq": { ar: "ريف دمشق", en: "Rif Dimashq", es: "Rif Dimashq", de: "Rif Dimaschq", tr: "Şam Kırsalı" },
            "aleppo": { ar: "حلب", en: "Aleppo", es: "Alepo", de: "Aleppo", tr: "Halep" },
            "homs": { ar: "حمص", en: "Homs", es: "Homs", de: "Homs", tr: "Humus" },
            "hama": { ar: "حماة", en: "Hama", es: "Hama", de: "Hama", tr: "Hama" },
            "lattakia": { ar: "اللاذقية", en: "Lattakia", es: "Latakia", de: "Latakia", tr: "Lazkiye" },
            "tartus": { ar: "طرطوس", en: "Tartus", es: "Tartús", de: "Tartus", tr: "Tartus" },
            "deir_ezzor": { ar: "دير الزور", en: "Deir Ezzor", es: "Deir Ezzor", de: "Deir ez-Zor", tr: "Deyrizor" },
            "alhasakah": { ar: "الحسكة", en: "Al-Hasakah", es: "Al-Hasaka", de: "Al-Hasaka", tr: "Haseke" },
            "alraqqah": { ar: "الرقة", en: "Al-Raqqah", es: "Al Raqa", de: "Ar-Raqqa", tr: "Rakka" },
            "idlib": { ar: "إدلب", en: "Idlib", es: "Idlib", de: "Idlib", tr: "İdlip" },
            "alsuweida": { ar: "السويداء", en: "As-Suwayda", es: "As-Suwayda", de: "As-Suwaida", tr: "Süveyda" },
            "daraa": { ar: "درعا", en: "Daraa", es: "Daraa", de: "Daraa", tr: "Dera" },
            "alqunaytirah": { ar: "القنيطرة", en: "Quneitra", es: "Quneitra", de: "Quneitra", tr: "Kuneytire" },

            // UI Elements - Keys should be unique and descriptive
            "app_title": { ar: "دليلك - تطبيق السياحة", en: "YourGuide - Tourism App", es: "TuGuía - App de Turismo", de: "DeinGuide - Tourismus-App", tr: "Rehberin - Turizm Uygulaması" },
            "logo_text": { ar: "دليلك", en: "YourGuide", es: "TuGuía", de: "DeinGuide", tr: "Rehberin" },
            "user_auth_status_visitor": { ar: "أنت تتصفح كـ <span class=\"font-semibold\">زائر</span>", en: "You are browsing as a <span class=\"font-semibold\">Visitor</span>", es: "Estás navegando como <span class=\"font-semibold\">Visitante</span>", de: "Sie browsen als <span class=\"font-semibold\">Besucher</span>", tr: "<span class=\"font-semibold\">Ziyaretçi</span> olarak geziniyorsunuz" },
            "user_auth_status_anonymous": { ar: "زائر مجهول", en: "Anonymous Visitor", es: "Visitante Anónimo", de: "Anonymer Besucher", tr: "Anonim Ziyaretçi" },
            "user_auth_status_current_user": { ar: "مستخدم حالي", en: "Current User", es: "Usuario Actual", de: "Aktueller Benutzer", tr: "Mevcut Kullanıcı" },
            "login_register_btn": { ar: "تسجيل/إنشاء حساب", en: "Login/Register", es: "Iniciar Sesión/Registrarse", de: "Anmelden/Registrieren", tr: "Giriş Yap/Kayıt Ol" },
            "add_establishment_btn": { ar: "أضف منشأتك", en: "Add Your Establishment", es: "Añade Tu Establecimiento", de: "Ihr Unternehmen Hinzufügen", tr: "Tesisini Ekle" },
            "my_establishments_btn": { ar: "منشآتي", en: "My Establishments", es: "Mis Establecimientos", de: "Meine Betriebe", tr: "Tesislerim" },
            "manage_paid_ads_btn": { ar: "إدارة الإعلانات", en: "Manage Ads", es: "Gestionar Anuncios", de: "Anzeigen Verwalten", tr: "Reklamları Yönet" },
            "logout_btn": { ar: "تسجيل الخروج", en: "Logout", es: "Cerrar Sesión", de: "Abmelden", tr: "Çıkış Yap" },
            "paid_ads_banner_title": { ar: "إعلانات مميزة", en: "Featured Ads", es: "Anuncios Destacados", de: "Top-Anzeigen", tr: "Öne Çıkan Reklamlar" },
            "filter_search_title": { ar: "فلترة البحث", en: "Filter Search", es: "Filtrar Búsqueda", de: "Suche Filtern", tr: "Aramayı Filtrele" },
            "category_filter_label": { ar: "التصنيف:", en: "Category:", es: "Categoría:", de: "Kategorie:", tr: "Kategori:" },
            "governorate_filter_label": { ar: "المحافظة:", en: "Governorate:", es: "Provincia:", de: "Gouvernement:", tr: "İl:" },
            "search_by_name_label": { ar: "البحث بالاسم:", en: "Search by Name:", es: "Buscar por Nombre:", de: "Suche nach Name:", tr: "Ada Göre Ara:" },
            "search_by_name_placeholder": { ar: "أدخل اسم المنشأة...", en: "Enter establishment name...", es: "Ingrese el nombre del establecimiento...", de: "Betriebsname eingeben...", tr: "Tesis adını girin..." },
            "apply_filters_btn": { ar: "تطبيق الفلاتر", en: "Apply Filters", es: "Aplicar Filtros", de: "Filter Anwenden", tr: "Filtreleri Uygula" },
            "useful_links_title": { ar: "روابط مفيدة", en: "Useful Links", es: "Enlaces Útiles", de: "Nützliche Links", tr: "Faydalı Bağlantılar" },
            "complaints_suggestions_link": { ar: "شكاوى واقتراحات", en: "Complaints & Suggestions", es: "Quejas y Sugerencias", de: "Beschwerden & Vorschläge", tr: "Şikayet & Öneriler" },
            "about_us_link": { ar: "من نحن", en: "About Us", es: "Sobre Nosotros", de: "Über Uns", tr: "Hakkımızda" },
            "latest_establishments_title": { ar: "أحدث المنشآت المضافة", en: "Latest Added Establishments", es: "Últimos Establecimientos Añadidos", de: "Neueste Hinzugefügte Betriebe", tr: "Son Eklenen Tesisler" },
            "my_establishments_page_title": { ar: "منشآتي", en: "My Establishments", es: "Mis Establecimientos", de: "Meine Betriebe", tr: "Tesislerim" },
            "loading_establishments_text": { ar: "جاري تحميل المنشآت...", en: "Loading establishments...", es: "Cargando establecimientos...", de: "Lade Betriebe...", tr: "Tesisler yükleniyor..." },
            "no_results_title": { ar: "لا توجد نتائج", en: "No Results", es: "Sin Resultados", de: "Keine Ergebnisse", tr: "Sonuç Yok" },
            "no_results_message_text": { ar: "لم يتم العثور على منشآت تطابق بحثك. حاول تغيير الفلاتر.", en: "No establishments found matching your search. Try changing the filters.", es: "No se encontraron establecimientos que coincidan con tu búsqueda. Intenta cambiar los filtros.", de: "Keine Betriebe gefunden, die Ihrer Suche entsprechen. Versuchen Sie, die Filter zu ändern.", tr: "Aramanızla eşleşen tesis bulunamadı. Filtreleri değiştirmeyi deneyin." },
            "interactive_map_title": { ar: "الخريطة التفاعلية", en: "Interactive Map", es: "Mapa Interactivo", de: "Interaktive Karte", tr: "İnteraktif Harita" },
            "locate_user_btn_map": { ar: "تحديد موقعي على الخريطة", en: "Locate me on the map", es: "Ubicarme en el mapa", de: "Meinen Standort auf der Karte anzeigen", tr: "Haritada beni bul" },
            "map_permission_note": { ar: "قد يطلب المتصفح الإذن للوصول إلى موقعك لعرضه على الخريطة.", en: "The browser may request permission to access your location to display it on the map.", es: "El navegador puede solicitar permiso para acceder a tu ubicación para mostrarla en el mapa.", de: "Der Browser fordert möglicherweise die Erlaubnis an, auf Ihren Standort zuzugreifen, um ihn auf der Karte anzuzeigen.", tr: "Tarayıcı, konumunuzu haritada görüntülemek için erişim izni isteyebilir." },
            "footer_copyright": { ar: `&copy; ${new Date().getFullYear()} دليلك. جميع الحقوق محفوظة.`, en: `&copy; ${new Date().getFullYear()} YourGuide. All rights reserved.`, es: `&copy; ${new Date().getFullYear()} TuGuía. Todos los derechos reservados.`, de: `&copy; ${new Date().getFullYear()} DeinGuide. Alle Rechte vorbehalten.`, tr: `&copy; ${new Date().getFullYear()} Rehberin. Tüm hakları saklıdır.` },
            "footer_tagline": { ar: "بوابتك إلى روائع سوريا", en: "Your gateway to the wonders of Syria", es: "Tu puerta de entrada a las maravillas de Siria", de: "Ihr Tor zu den Wundern Syriens", tr: "Suriye'nin harikalarına açılan kapınız" },
            "view_details_btn": { ar: "عرض التفاصيل", en: "View Details", es: "Ver Detalles", de: "Details Anzeigen", tr: "Detayları Gör" },
            "about_us_modal_title": { ar: "من نحن", en: "About Us", es: "Sobre Nosotros", de: "Über Uns", tr: "Hakkımızda" },
            "about_us_modal_content1": { ar: "تطبيق \"دليلك\" هو مبادرتك الأولى لاستكشاف كنوز سوريا السياحية والخدمية. نحن هنا لنبني جسراً يربط بين أصحاب المنشآت المبدعين والزوار الباحثين عن تجارب لا تُنسى.", en: "\"YourGuide\" application is your first initiative to explore Syria's tourism and service treasures. We are here to build a bridge connecting creative establishment owners and visitors seeking unforgettable experiences.", es: "La aplicación \"TuGuía\" es tu primera iniciativa para explorar los tesoros turísticos y de servicios de Siria. Estamos aquí para construir un puente que conecte a los propietarios de establecimientos creativos y a los visitantes que buscan experiencias inolvidables.", de: "Die Anwendung \"DeinGuide\" ist Ihre erste Initiative, um Syriens Tourismus- und Dienstleistungsschätze zu erkunden. Wir sind hier, um eine Brücke zwischen kreativen Betriebsinhabern und Besuchern zu bauen, die unvergessliche Erlebnisse suchen.", tr: "\"Rehberin\" uygulaması, Suriye'nin turizm ve hizmet hazinelerini keşfetmeniz için ilk girişiminizdir. Yaratıcı tesis sahipleri ile unutulmaz deneyimler arayan ziyaretçiler arasında bir köprü kurmak için buradayız." },
            "about_us_modal_content2": { ar: "هدفنا هو توفير منصة سهلة، غنية بالمعلومات الدقيقة والمحدثة، لتساعدك في التخطيط لرحلتك القادمة أو لاكتشاف جوهرة مخفية بالقرب منك. انضم إلينا في رحلة إثراء السياحة السورية!", en: "Our goal is to provide an easy platform, rich with accurate and updated information, to help you plan your next trip or discover a hidden gem near you. Join us on a journey to enrich Syrian tourism!", es: "Nuestro objetivo es proporcionar una plataforma fácil, rica en información precisa y actualizada, para ayudarte a planificar tu próximo viaje o descubrir una joya escondida cerca de ti. ¡Únete a nosotros en un viaje para enriquecer el turismo sirio!", de: "Unser Ziel ist es, eine einfache Plattform bereitzustellen, die reich an genauen und aktuellen Informationen ist, um Ihnen bei der Planung Ihrer nächsten Reise oder der Entdeckung eines versteckten Juwels in Ihrer Nähe zu helfen. Begleiten Sie uns auf einer Reise zur Bereicherung des syrischen Tourismus!", tr: "Amacımız, bir sonraki seyahatinizi planlamanıza veya yakınınızdaki gizli bir mücevheri keşfetmenize yardımcı olmak için doğru ve güncel bilgilerle zengin, kolay bir platform sağlamaktır. Suriye turizmini zenginleştirme yolculuğunda bize katılın!" },
            "got_it_btn": { ar: "فهمت!", en: "Got it!", es: "¡Entendido!", de: "Verstanden!", tr: "Anladım!" },
            "manage_paid_ads_modal_title": { ar: "إدارة الإعلانات المدفوعة", en: "Manage Paid Ads", es: "Gestionar Anuncios Pagados", de: "Bezahlte Anzeigen Verwalten", tr: "Ücretli Reklamları Yönet" },
            "establishment_id_label": { ar: "معرّف المنشأة (ID):", en: "Establishment ID:", es: "ID del Establecimiento:", de: "Betriebs-ID:", tr: "Tesis Kimliği:" },
            "establishment_id_placeholder": { ar: "أدخل ID المنشأة لتفعيل/إلغاء الإعلان", en: "Enter Establishment ID to activate/deactivate ad", es: "Ingrese el ID del establecimiento para activar/desactivar el anuncio", de: "Geben Sie die Betriebs-ID ein, um die Anzeige zu aktivieren/deaktivieren", tr: "Reklamı etkinleştirmek/devre dışı bırakmak için Tesis Kimliğini girin" },
            "establishment_id_note": { ar: "يمكنك الحصول على ID المنشأة من لوحة تحكم Firebase.", en: "You can get the Establishment ID from the Firebase console.", es: "Puedes obtener el ID del establecimiento desde la consola de Firebase.", de: "Sie erhalten die Betriebs-ID von der Firebase-Konsole.", tr: "Tesis Kimliğini Firebase konsolundan alabilirsiniz." },
            "toggle_ad_status_btn": { ar: "تبديل حالة الإعلان", en: "Toggle Ad Status", es: "Cambiar Estado del Anuncio", de: "Anzeigenstatus Umschalten", tr: "Reklam Durumunu Değiştir" },
            "cancel_btn": { ar: "إلغاء", en: "Cancel", es: "Cancelar", de: "Abbrechen", tr: "İptal" },
            "login_modal_title": { ar: "تسجيل الدخول", en: "Login", es: "Iniciar Sesión", de: "Anmelden", tr: "Giriş Yap" },
            "email_label": { ar: "البريد الإلكتروني", en: "Email", es: "Correo Electrónico", de: "Email", tr: "E-posta" },
            "email_placeholder": { ar: "example@mail.com", en: "example@mail.com", es: "ejemplo@correo.com", de: "beispiel@mail.com", tr: "ornek@posta.com" },
            "password_label": { ar: "كلمة المرور", en: "Password", es: "Contraseña", de: "Passwort", tr: "Şifre" },
            "password_placeholder": { ar: "••••••••", en: "••••••••", es: "••••••••", de: "••••••••", tr: "••••••••" },
            "login_btn_modal": { ar: "دخول", en: "Login", es: "Entrar", de: "Anmelden", tr: "Giriş Yap" },
            "no_account_switch_to_register": { ar: "ليس لديك حساب؟ أنشئ حساباً جديداً", en: "Don't have an account? Create a new one", es: "¿No tienes una cuenta? Crea una nueva", de: "Kein Konto? Erstellen Sie ein neues", tr: "Hesabınız yok mu? Yeni bir tane oluşturun" },
            "login_success_title": { ar: "تم بنجاح!", en: "Success!", es: "¡Éxito!", de: "Erfolg!", tr: "Başarılı!" },
            "login_success_text": { ar: "تم تسجيل دخولك بنجاح.", en: "You have successfully logged in.", es: "Has iniciado sesión correctamente.", de: "Sie haben sich erfolgreich angemeldet.", tr: "Başarıyla giriş yaptınız." },
            "login_fail_message_generic": { ar: "فشل تسجيل الدخول. يرجى التحقق من البيانات.", en: "Login failed. Please check your credentials.", es: "Falló el inicio de sesión. Por favor, verifica tus datos.", de: "Anmeldung fehlgeschlagen. Bitte überprüfen Sie Ihre Daten.", tr: "Giriş başarısız. Lütfen bilgilerinizi kontrol edin." },
            "login_fail_message_specific": { ar: "البريد الإلكتروني أو كلمة المرور غير صحيحة.", en: "Incorrect email or password.", es: "Correo electrónico o contraseña incorrectos.", de: "Falsche E-Mail-Adresse oder falsches Passwort.", tr: "Yanlış e-posta veya şifre." },
            "fill_all_fields_validation": { ar: "يرجى ملء جميع الحقول", en: "Please fill in all fields", es: "Por favor, rellena todos los campos", de: "Bitte füllen Sie alle Felder aus", tr: "Lütfen tüm alanları doldurun" },
            "register_modal_title": { ar: "إنشاء حساب جديد", en: "Create New Account", es: "Crear Nueva Cuenta", de: "Neues Konto Erstellen", tr: "Yeni Hesap Oluştur" },
            "full_name_label": { ar: "الاسم الكامل:", en: "Full Name:", es: "Nombre Completo:", de: "Vollständiger Name:", tr: "Tam Adınız:" },
            "password_min_chars_label": { ar: "كلمة المرور (6 أحرف على الأقل):", en: "Password (min. 6 characters):", es: "Contraseña (mín. 6 caracteres):", de: "Passwort (mind. 6 Zeichen):", tr: "Şifre (en az 6 karakter):" },
            "account_type_label": { ar: "نوع الحساب:", en: "Account Type:", es: "Tipo de Cuenta:", de: "Kontotyp:", tr: "Hesap Türü:" },
            "role_investor_label": { ar: "مستثمر (صاحب منشأة)", en: "Investor (Establishment Owner)", es: "Inversor (Propietario de Establecimiento)", de: "Investor (Betriebsinhaber)", tr: "Yatırımcı (Tesis Sahibi)" },
            "role_visitor_label": { ar: "زائر (سائح)", en: "Visitor (Tourist)", es: "Visitante (Turista)", de: "Besucher (Tourist)", tr: "Ziyaretçi (Turist)" },
            "select_account_type_validation": { ar: "يرجى اختيار نوع الحساب.", en: "Please select an account type.", es: "Por favor, selecciona un tipo de cuenta.", de: "Bitte wählen Sie einen Kontotyp aus.", tr: "Lütfen bir hesap türü seçin." },
            "create_account_btn": { ar: "إنشاء حساب", en: "Create Account", es: "Crear Cuenta", de: "Konto Erstellen", tr: "Hesap Oluştur" },
            "already_have_account_switch_to_login": { ar: "لديك حساب بالفعل؟ سجل الدخول", en: "Already have an account? Log in", es: "¿Ya tienes una cuenta? Inicia sesión", de: "Bereits ein Konto? Anmelden", tr: "Zaten bir hesabınız var mı? Giriş yapın" },
            "registration_success_title": { ar: "تم بنجاح!", en: "Success!", es: "¡Éxito!", de: "Erfolg!", tr: "Başarılı!" },
            "registration_success_text": { ar: "تم إنشاء حسابك وتسجيل دخولك.", en: "Your account has been created and you are logged in.", es: "Tu cuenta ha sido creada y has iniciado sesión.", de: "Ihr Konto wurde erstellt und Sie sind angemeldet.", tr: "Hesabınız oluşturuldu ve giriş yaptınız." },
            "registration_fail_generic": { ar: "فشل إنشاء الحساب.", en: "Account creation failed.", es: "Falló la creación de la cuenta.", de: "Kontoerstellung fehlgeschlagen.", tr: "Hesap oluşturma başarısız oldu." },
            "registration_fail_email_in_use": { ar: "هذا البريد الإلكتروني مسجل مسبقاً.", en: "This email is already registered.", es: "Este correo electrónico ya está registrado.", de: "Diese E-Mail-Adresse ist bereits registriert.", tr: "Bu e-posta zaten kayıtlı." },
            "registration_fail_weak_password": { ar: "كلمة المرور ضعيفة جداً.", en: "Password is too weak.", es: "La contraseña es demasiado débil.", de: "Das Passwort ist zu schwach.", tr: "Şifre çok zayıf." },
            "add_establishment_modal_title": { ar: "إضافة منشأة جديدة", en: "Add New Establishment", es: "Añadir Nuevo Establecimiento", de: "Neuen Betrieb Hinzufügen", tr: "Yeni Tesis Ekle" },
            "establishment_name_label": { ar: "اسم المنشأة:", en: "Establishment Name:", es: "Nombre del Establecimiento:", de: "Name des Betriebs:", tr: "Tesis Adı:" },
            "establishment_name_placeholder_ar": { ar: "الاسم بالعربية", en: "Name in Arabic", es: "Nombre en Árabe", de: "Name auf Arabisch", tr: "Arapça İsim" },
            "establishment_name_placeholder_en": { ar: "الاسم بالإنجليزية", en: "Name in English", es: "Nombre en Inglés", de: "Name auf Englisch", tr: "İngilizce İsim" },
            "establishment_name_placeholder_es": { ar: "الاسم بالإسبانية", en: "Name in Spanish", es: "Nombre en Español", de: "Name auf Spanisch", tr: "İspanyolca İsim" },
            "establishment_name_placeholder_de": { ar: "الاسم بالألمانية", en: "Name in German", es: "Nombre en Alemán", de: "Name auf Deutsch", tr: "Almanca İsim" },
            "establishment_name_placeholder_tr": { ar: "الاسم بالتركية", en: "Name in Turkish", es: "Nombre en Turco", de: "Name auf Türkisch", tr: "Türkçe İsim" },
            "category_label_add_modal": { ar: "التصنيف:", en: "Category:", es: "Categoría:", de: "Kategorie:", tr: "Kategori:" },
            "select_category_option": { ar: "اختر التصنيف", en: "Select Category", es: "Seleccionar Categoría", de: "Kategorie Wählen", tr: "Kategori Seçin" },
            "governorate_label_add_modal": { ar: "المحافظة:", en: "Governorate:", es: "Provincia:", de: "Gouvernement:", tr: "İl:" },
            "select_governorate_option": { ar: "اختر المحافظة", en: "Select Governorate", es: "Seleccionar Provincia", de: "Gouvernement Wählen", tr: "İl Seçin" },
            "description_label": { ar: "وصف المنشأة:", en: "Establishment Description:", es: "Descripción del Establecimiento:", de: "Beschreibung des Betriebs:", tr: "Tesis Açıklaması:" },
            "description_placeholder_ar": { ar: "الوصف بالعربية", en: "Description in Arabic", es: "Descripción en Árabe", de: "Beschreibung auf Arabisch", tr: "Arapça Açıklama" },
            "description_placeholder_en": { ar: "الوصف بالإنجليزية", en: "Description in English", es: "Descripción en Inglés", de: "Beschreibung auf Englisch", tr: "İngilizce Açıklama" },
            "description_placeholder_es": { ar: "الوصف بالإسبانية", en: "Description in Spanish", es: "Descripción en Español", de: "Beschreibung auf Spanisch", tr: "İspanyolca Açıklama" },
            "description_placeholder_de": { ar: "الوصف بالألمانية", en: "Description in German", es: "Descripción en Alemán", de: "Beschreibung auf Deutsch", tr: "Almanca Açıklama" },
            "description_placeholder_tr": { ar: "الوصف بالتركية", en: "Description in Turkish", es: "Descripción en Turco", de: "Beschreibung auf Türkisch", tr: "Türkçe Açıklama" },
            "location_text_label": { ar: "الموقع (نص وصفي):", en: "Location (descriptive text):", es: "Ubicación (texto descriptivo):", de: "Standort (beschreibender Text):", tr: "Konum (açıklayıcı metin):" },
            "location_text_placeholder_ar": { ar: "الموقع بالعربية", en: "Location in Arabic", es: "Ubicación en Árabe", de: "Standort auf Arabisch", tr: "Arapça Konum" },
            "location_text_placeholder_en": { ar: "الموقع بالإنجليزية", en: "Location in English", es: "Ubicación en Inglés", de: "Standort auf Englisch", tr: "İngilizce Konum" },
            "location_text_placeholder_es": { ar: "الموقع بالإسبانية", en: "Location in Spanish", es: "Ubicación en Español", de: "Standort auf Spanisch", tr: "İspanyolca Konum" },
            "location_text_placeholder_de": { ar: "الموقع بالألمانية", en: "Location in German", es: "Ubicación en Alemán", de: "Standort auf Deutsch", tr: "Almanca Konum" },
            "location_text_placeholder_tr": { ar: "الموقع بالتركية", en: "Location in Turkish", es: "Ubicación en Turco", de: "Standort auf Türkisch", tr: "Türkçe Konum" },
            "price_range_label": { ar: "السعر/نطاق السعر (اختياري):", en: "Price/Price Range (optional):", es: "Precio/Rango de Precios (opcional):", de: "Preis/Preisspanne (optional):", tr: "Fiyat/Fiyat Aralığı (isteğe bağlı):" },
            "price_range_placeholder_ar": { ar: "نطاق السعر بالعربية. مثال: 5000 ل.س", en: "Price range in Arabic. Ex: 5000 SYP", es: "Rango de precios en Árabe. Ej: 5000 SYP", de: "Preisspanne auf Arabisch. Bsp: 5000 SYP", tr: "Arapça fiyat aralığı. Örn: 5000 SYP" },
            "price_range_placeholder_en": { ar: "نطاق السعر بالإنجليزية", en: "Price range in English", es: "Rango de precios en Inglés", de: "Preisspanne auf Englisch", tr: "İngilizce fiyat aralığı" },
            "price_range_placeholder_es": { ar: "نطاق السعر بالإسبانية", en: "Price range in Spanish", es: "Rango de precios en Español", de: "Preisspanne auf Spanisch", tr: "İspanyolca fiyat aralığı" },
            "price_range_placeholder_de": { ar: "نطاق السعر بالألمانية", en: "Price range in German", es: "Rango de precios en Alemán", de: "Preisspanne auf Deutsch", tr: "Almanca fiyat aralığı" },
            "price_range_placeholder_tr": { ar: "نطاق السعر بالتركية", en: "Price range in Turkish", es: "Rango de precios en Turco", de: "Preisspanne auf Türkisch", tr: "Türkçe fiyat aralığı" },
            "select_location_on_map_btn": { ar: "تحديد الموقع على الخريطة", en: "Select Location on Map", es: "Seleccionar Ubicación en el Mapa", de: "Standort auf Karte Wählen", tr: "Haritada Konum Seç" },
            "coordinates_placeholder": { ar: "الإحداثيات (خط العرض، خط الطول)", en: "Coordinates (Latitude, Longitude)", es: "Coordenadas (Latitud, Longitud)", de: "Koordinaten (Breitengrad, Längengrad)", tr: "Koordinatlar (Enlem, Boylam)" },
            "photos_label": { ar: "صور المنشأة (5 كحد أقصى, 1MB لكل صورة بعد الضغط):", en: "Establishment Photos (max 5, 1MB each after compression):", es: "Fotos del Establecimiento (máx. 5, 1MB c/u después de compresión):", de: "Betriebsfotos (max. 5, je 1MB nach Komprimierung):", tr: "Tesis Fotoğrafları (en fazla 5, sıkıştırma sonrası her biri 1MB):" },
            "add_establishment_submit_btn": { ar: "إضافة المنشأة", en: "Add Establishment", es: "Añadir Establecimiento", de: "Betrieb Hinzufügen", tr: "Tesisi Ekle" },
            "add_establishment_validation_error": { ar: "يرجى ملء جميع الحقول المطلوبة.", en: "Please fill all required fields.", es: "Por favor, rellena todos los campos obligatorios.", de: "Bitte füllen Sie alle Pflichtfelder aus.", tr: "Lütfen tüm zorunlu alanları doldurun." },
            "select_location_validation_error": { ar: "يرجى تحديد موقع المنشأة على الخريطة.", en: "Please select the establishment location on the map.", es: "Por favor, selecciona la ubicación del establecimiento en el mapa.", de: "Bitte wählen Sie den Standort des Betriebs auf der Karte aus.", tr: "Lütfen tesisin konumunu haritada seçin." },
            "adding_establishment_feedback": { ar: "جاري إضافة المنشأة...", en: "Adding establishment...", es: "Añadiendo establecimiento...", de: "Betrieb wird hinzugefügt...", tr: "Tesis ekleniyor..." },
            "add_establishment_success_text": { ar: "تمت إضافة المنشأة بنجاح! ستظهر بعد المراجعة والموافقة.", en: "Establishment added successfully! It will appear after review and approval.", es: "¡Establecimiento añadido con éxito! Aparecerá después de la revisión y aprobación.", de: "Betrieb erfolgreich hinzugefügt! Er wird nach Überprüfung und Genehmigung angezeigt.", tr: "Tesis başarıyla eklendi! İnceleme ve onaydan sonra görünecektir." },
            "add_establishment_error_feedback": { ar: "خطأ في إضافة المنشأة:", en: "Error adding establishment:", es: "Error al añadir el establecimiento:", de: "Fehler beim Hinzufügen des Betriebs:", tr: "Tesis eklenirken hata oluştu:" },
            "add_establishment_validation_error_auth": { ar: "يجب أن تكون مسجلاً كمستثمر لإضافة منشأة.", en: "You must be logged in as an investor to add an establishment.", es: "Debes iniciar sesión como inversor para añadir un establecimiento.", de: "Sie müssen als Investor angemeldet sein, um einen Betrieb hinzuzufügen.", tr: "Bir tesis eklemek için yatırımcı olarak giriş yapmalısınız." },
            "pick_location_modal_title": { ar: "تحديد موقع المنشأة على الخريطة", en: "Select Establishment Location on Map", es: "Seleccionar Ubicación del Establecimiento en el Mapa", de: "Betriebsstandort auf Karte Wählen", tr: "Haritada Tesis Konumunu Seçin" },
            "use_my_location_btn_picker": { ar: "استخدام موقعي الحالي", en: "Use My Current Location", es: "Usar Mi Ubicación Actual", de: "Meinen Aktuellen Standort Verwenden", tr: "Mevcut Konumumu Kullan" },
            "click_map_to_select_location_note": { ar: "انقر على الخريطة لتحديد الموقع أو استخدم زر \"تحديد موقعي\".", en: "Click on the map to select the location or use the \"Use My Location\" button.", es: "Haz clic en el mapa para seleccionar la ubicación o usa el botón \"Usar Mi Ubicación\".", de: "Klicken Sie auf die Karte, um den Standort auszuwählen, oder verwenden Sie die Schaltfläche \"Meinen Standort verwenden\".", tr: "Konumu seçmek için haritaya tıklayın veya \"Mevcut Konumumu Kullan\" düğmesini kullanın." },
            "confirm_location_btn": { ar: "تأكيد الموقع", en: "Confirm Location", es: "Confirmar Ubicación", de: "Standort Bestätigen", tr: "Konumu Onayla" },
            "location_picker_validation_error": { ar: "يرجى تحديد موقع على الخريطة بالنقر عليه أو استخدام زر \"تحديد موقعي\".", en: "Please select a location on the map by clicking it or using the \"Use My Location\" button.", es: "Por favor, selecciona una ubicación en el mapa haciendo clic en ella o usando el botón \"Usar Mi Ubicación\".", de: "Bitte wählen Sie einen Standort auf der Karte aus, indem Sie darauf klicken oder die Schaltfläche \"Meinen Standort verwenden\" verwenden.", tr: "Lütfen haritada bir konum seçmek için tıklayın veya \"Mevcut Konumumu Kullan\" düğmesini kullanın." },
            "error_getting_current_location": { ar: "لم نتمكن من تحديد موقعك الحالي.", en: "We could not determine your current location.", es: "No pudimos determinar tu ubicación actual.", de: "Wir konnten Ihren aktuellen Standort nicht bestimmen.", tr: "Mevcut konumunuzu belirleyemedik." },
            "request_paid_ad_error_login": { ar: "يجب تسجيل الدخول لطلب إعلان مميز.", en: "You must be logged in to request a featured ad.", es: "Debes iniciar sesión para solicitar un anuncio destacado.", de: "Sie müssen angemeldet sein, um eine Top-Anzeige anzufordern.", tr: "Öne çıkan reklam talep etmek için giriş yapmalısınız." },
            "request_paid_ad_success_title": { ar: "تم إرسال الطلب", en: "Request Sent", es: "Solicitud Enviada", de: "Anfrage Gesendet", tr: "Talep Gönderildi" },
            "request_paid_ad_success_text": { ar: "تم إرسال طلبك لجعل هذه المنشأة إعلانًا مميزًا. سيتم مراجعته من قبل الإدارة.", en: "Your request to make this establishment a featured ad has been sent. It will be reviewed by the administration.", es: "Tu solicitud para hacer de este establecimiento un anuncio destacado ha sido enviada. Será revisada por la administración.", de: "Ihre Anfrage, diesen Betrieb zu einer Top-Anzeige zu machen, wurde gesendet. Sie wird von der Verwaltung überprüft.", tr: "Bu tesisi öne çıkan bir reklam yapma talebiniz gönderildi. Yönetim tarafından incelenecektir." },
            "request_paid_ad_error_text": { ar: "لم نتمكن من إرسال طلب الإعلان المميز. حاول مرة أخرى.", en: "We could not send the featured ad request. Try again.", es: "No pudimos enviar la solicitud de anuncio destacado. Inténtalo de nuevo.", de: "Wir konnten die Anfrage für die Top-Anzeige nicht senden. Versuchen Sie es erneut.", tr: "Öne çıkan reklam talebi gönderilemedi. Tekrar deneyin." },
            "my_establishments_owner_only_alert": { ar: "هذه الميزة متاحة لأصحاب المنشآت فقط.", en: "This feature is available for establishment owners only.", es: "Esta función está disponible solo para propietarios de establecimientos.", de: "Diese Funktion ist nur für Betriebsinhaber verfügbar.", tr: "Bu özellik yalnızca tesis sahipleri için geçerlidir." },
            "my_establishments_login_alert": { ar: "يرجى تسجيل الدخول كصاحب منشأة لعرض منشآتك.", en: "Please log in as an establishment owner to view your establishments.", es: "Por favor, inicia sesión como propietario de un establecimiento para ver tus establecimientos.", de: "Bitte melden Sie sich als Betriebsinhaber an, um Ihre Betriebe anzuzeigen.", tr: "Tesislerinizi görüntülemek için lütfen bir tesis sahibi olarak giriş yapın." },
            "establishment_name_not_available": { ar: "اسم غير متوفر", en: "Name not available", es: "Nombre no disponible", de: "Name nicht verfügbar", tr: "İsim mevcut değil" },
            "no_description": { ar: "لا يوجد وصف", en: "No description", es: "Sin descripción", de: "Keine Beschreibung", tr: "Açıklama yok" },
            "category_placeholder_card": { ar: "فئة", en: "Category", es: "Categoría", de: "Kategorie", tr: "Kategori" },
            "pending_review_badge": { ar: "قيد المراجعة", en: "Pending Review", es: "Pendiente de Revisión", de: "Wartet auf Überprüfung", tr: "İncelemede" },
            "paid_ad_request_badge": { ar: "طلب إعلان مميز", en: "Featured Ad Request", es: "Solicitud de Anuncio Destacado", de: "Anfrage für Top-Anzeige", tr: "Öne Çıkan Reklam Talebi" },
            "ratings_count_text": { ar: "تقييمات", en: "ratings", es: "valoraciones", de: "Bewertungen", tr: "değerlendirme" },
            "governorate_not_specified": { ar: "غير محدد", en: "Not specified", es: "No especificado", de: "Nicht angegeben", tr: "Belirtilmemiş" },
            "establishment_details_error_title": { ar: "خطأ", en: "Error", es: "Error", de: "Fehler", tr: "Hata" },
            "establishment_details_not_found": { ar: "لم يتم العثور على تفاصيل المنشأة.", en: "Establishment details not found.", es: "No se encontraron los detalles del establecimiento.", de: "Betriebsdetails nicht gefunden.", tr: "Tesis detayları bulunamadı." },
            "error_loading_details_text": { ar: "حدث خطأ أثناء تحميل التفاصيل:", en: "An error occurred while loading details:", es: "Ocurrió un error al cargar los detalles:", de: "Beim Laden der Details ist ein Fehler aufgetreten:", tr: "Detaylar yüklenirken bir hata oluştu:" },
            "description_details_label": { ar: "الوصف:", en: "Description:", es: "Descripción:", de: "Beschreibung:", tr: "Açıklama:" },
            "governorate_details_label": { ar: "المحافظة:", en: "Governorate:", es: "Provincia:", de: "Gouvernement:", tr: "İl:" },
            "category_details_label": { ar: "الفئة:", en: "Category:", es: "Categoría:", de: "Kategorie:", tr: "Kategori:" },
            "location_text_details_label": { ar: "الموقع (نصي):", en: "Location (text):", es: "Ubicación (texto):", de: "Standort (Text):", tr: "Konum (metin):" },
            "coordinates_details_label": { ar: "الإحداثيات:", en: "Coordinates:", es: "Coordenadas:", de: "Koordinaten:", tr: "Koordinatlar:" },
            "price_details_label": { ar: "السعر:", en: "Price:", es: "Precio:", de: "Preis:", tr: "Fiyat:" },
            "rating_details_label": { ar: "التقييم:", en: "Rating:", es: "Valoración:", de: "Bewertung:", tr: "Puan:" },
            "request_featured_ad_btn_details": { ar: "اطلب جعل هذا إعلانًا مميزًا", en: "Request to make this a featured ad", es: "Solicitar hacer de esto un anuncio destacado", de: "Anfordern, dies zu einer Top-Anzeige zu machen", tr: "Bunu öne çıkan bir reklam yapmayı talep et" },
            "featured_ad_request_pending_text": { ar: "طلب الإعلان المميز قيد المراجعة.", en: "Featured ad request is pending review.", es: "La solicitud de anuncio destacado está pendiente de revisión.", de: "Die Anfrage für eine Top-Anzeige wird derzeit überprüft.", tr: "Öne çıkan reklam talebi inceleniyor." },
            "is_featured_ad_text": { ar: "هذه المنشأة إعلان مميز.", en: "This establishment is a featured ad.", es: "Este establecimiento es un anuncio destacado.", de: "Dieser Betrieb ist eine Top-Anzeige.", tr: "Bu tesis öne çıkan bir reklamdır." },
            "add_your_rating_title": { ar: "أضف تقييمك", en: "Add Your Rating", es: "Añade Tu Valoración", de: "Ihre Bewertung Hinzufügen", tr: "Puanınızı Ekleyin" },
            "rating_excellent": { ar: "ممتاز", en: "Excellent", es: "Excelente", de: "Ausgezeichnet", tr: "Mükemmel" },
            "rating_very_good": { ar: "جيد جداً", en: "Very Good", es: "Muy Bueno", de: "Sehr Gut", tr: "Çok İyi" },
            "rating_good": { ar: "جيد", en: "Good", es: "Bueno", de: "Gut", tr: "İyi" },
            "rating_fair": { ar: "مقبول", en: "Fair", es: "Aceptable", de: "Akzeptabel", tr: "Kabul Edilebilir" },
            "rating_poor": { ar: "سيء", en: "Poor", es: "Malo", de: "Schlecht", tr: "Kötü" },
            "rating_comment_placeholder": { ar: "اكتب تعليقك هنا...", en: "Write your comment here...", es: "Escribe tu comentario aquí...", de: "Schreiben Sie hier Ihren Kommentar...", tr: "Yorumunuzu buraya yazın..." },
            "submit_rating_btn": { ar: "إرسال التقييم", en: "Submit Rating", es: "Enviar Valoración", de: "Bewertung Senden", tr: "Puanı Gönder" },
            "loading_ratings_text": { ar: "جاري تحميل التقييمات...", en: "Loading ratings...", es: "Cargando valoraciones...", de: "Lade Bewertungen...", tr: "Puanlar yükleniyor..." },
            "no_ratings_yet_text": { ar: "لا توجد تقييمات بعد.", en: "No ratings yet.", es: "Aún no hay valoraciones.", de: "Noch keine Bewertungen.", tr: "Henüz puan yok." },
            "ratings_list_title": { ar: "التقييمات:", en: "Ratings:", es: "Valoraciones:", de: "Bewertungen:", tr: "Puanlar:" },
            "visitor_text": { ar: "زائر", en: "Visitor", es: "Visitante", de: "Besucher", tr: "Ziyaretçi" },
            "no_comment_text": { ar: "لا يوجد تعليق", en: "No comment", es: "Sin comentario", de: "Kein Kommentar", tr: "Yorum yok" },
            "error_loading_ratings_text": { ar: "خطأ تحميل التقييمات.", en: "Error loading ratings.", es: "Error al cargar las valoraciones.", de: "Fehler beim Laden der Bewertungen.", tr: "Puanlar yüklenirken hata oluştu." },
            "index_required_for_query_text": { ar: "يتطلب الاستعلام فهرسًا. يرجى مراجعة وحدة التحكم لإنشائه.", en: "Query requires an index. Please check the console to create it.", es: "La consulta requiere un índice. Por favor, revisa la consola para crearlo.", de: "Die Abfrage erfordert einen Index. Bitte überprüfen Sie die Konsole, um ihn zu erstellen.", tr: "Sorgu bir dizin gerektiriyor. Lütfen oluşturmak için konsolu kontrol edin." },
            "login_to_rate_text": { ar: "يجب تسجيل الدخول لتقديم تقييم.", en: "You must be logged in to submit a rating.", es: "Debes iniciar sesión para enviar una valoración.", de: "Sie müssen angemeldet sein, um eine Bewertung abzugeben.", tr: "Puan göndermek için giriş yapmalısınız." },
            "select_satisfaction_level_text": { ar: "يرجى اختيار مستوى الرضا.", en: "Please select a satisfaction level.", es: "Por favor, selecciona un nivel de satisfacción.", de: "Bitte wählen Sie ein Zufriedenheitsniveau aus.", tr: "Lütfen bir memnuniyet seviyesi seçin." },
            "submitting_rating_text": { ar: "جاري الإرسال...", en: "Submitting...", es: "Enviando...", de: "Wird gesendet...", tr: "Gönderiliyor..." },
            "rating_submitted_successfully_text": { ar: "تم إرسال تقييمك بنجاح!", en: "Your rating has been submitted successfully!", es: "¡Tu valoración ha sido enviada con éxito!", de: "Ihre Bewertung wurde erfolgreich gesendet!", tr: "Puanınız başarıyla gönderildi!" },
            "error_submitting_rating_text": { ar: "حدث خطأ:", en: "An error occurred:", es: "Ocurrió un error:", de: "Ein Fehler ist aufgetreten:", tr: "Bir hata oluştu:" },
            "error_loading_paid_ads": { ar: "خطأ في تحميل الإعلانات.", en: "Error loading ads.", es: "Error al cargar los anuncios.", de: "Fehler beim Laden der Anzeigen.", tr: "Reklamlar yüklenirken hata oluştu." },
            "map_marker_your_location": { ar: "موقعك الحالي", en: "Your current location", es: "Tu ubicación actual", de: "Ihr aktueller Standort", tr: "Mevcut konumunuz" },
            "map_marker_error_locating": { ar: "لم نتمكن من تحديد موقعك. يرجى التأكد من تفعيل خدمات الموقع والموافقة على الإذن.", en: "We could not determine your location. Please ensure location services are enabled and permission is granted.", es: "No pudimos determinar tu ubicación. Asegúrate de que los servicios de ubicación estén habilitados y se haya otorgado el permiso.", de: "Wir konnten Ihren Standort nicht bestimmen. Bitte stellen Sie sicher, dass die Ortungsdienste aktiviert sind und die Berechtigung erteilt wurde.", tr: "Konumunuzu belirleyemedik. Lütfen konum servislerinin etkinleştirildiğinden ve izin verildiğinden emin olun." },
            "map_marker_geolocation_not_supported": { ar: "المتصفح لا يدعم تحديد الموقع الجغرافي.", en: "Geolocation is not supported by this browser.", es: "La geolocalización no es compatible con este navegador.", de: "Geolocation wird von diesem Browser nicht unterstützt.", tr: "Coğrafi konum bu tarayıcı tarafından desteklenmiyor." },
            "map_marker_selected_location": { ar: "الموقع المحدد", en: "Selected Location", es: "Ubicación Seleccionada", de: "Ausgewählter Standort", tr: "Seçilen Konum" },
            "map_marker_establishment_location": { ar: "الموقع المحدد للمنشأة", en: "Selected location for the establishment", es: "Ubicación seleccionada para el establecimiento", de: "Ausgewählter Standort für den Betrieb", tr: "Tesis için seçilen konum" },
            "map_marker_current_location_selected": { ar: "الموقع المحدد (موقعك الحالي)", en: "Selected location (your current location)", es: "Ubicación seleccionada (tu ubicación actual)", de: "Ausgewählter Standort (Ihr aktueller Standort)", tr: "Seçilen konum (mevcut konumunuz)" },
            "auth_error_anon_signin_disabled": { ar: "خطأ: المصادقة المجهولة غير مفعلة.", en: "Error: Anonymous authentication is not enabled.", es: "Error: La autenticación anónima no está habilitada.", de: "Fehler: Anonyme Authentifizierung ist nicht aktiviert.", tr: "Hata: Anonim kimlik doğrulama etkin değil." },
            "auth_error_initial_failed": { ar: "خطأ في المصادقة الأولية.", en: "Initial authentication error.", es: "Error de autenticación inicial.", de: "Fehler bei der anfänglichen Authentifizierung.", tr: "İlk kimlik doğrulama hatası." },
             "error_firebase_init": { ar: "خطأ في تهيئة التطبيق. يرجى المحاولة مرة أخرى لاحقاً.", en: "Error initializing the application. Please try again later.", es: "Error al inicializar la aplicación. Por favor, inténtalo de nuevo más tarde.", de: "Fehler beim Initialisieren der Anwendung. Bitte versuchen Sie es später erneut.", tr: "Uygulama başlatılırken hata oluştu. Lütfen daha sonra tekrar deneyin." },
            "error_loading_establishments": { ar: "خطأ في تحميل المنشآت:", en: "Error loading establishments:", es: "Error al cargar los establecimientos:", de: "Fehler beim Laden der Betriebe:", tr: "Tesisler yüklenirken hata oluştu:" },
            "error_firestore_index_required": { ar: `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <h3 class="font-bold">خطأ في قاعدة البيانات!</h3>
                    <p>الاستعلام يتطلب فهرسًا غير موجود في Firestore.</p>
                    <p class="mt-2"><strong>الحل:</strong> يرجى الانتقال إلى وحدة تحكم Firebase لمشروعك وإنشاء الفهرس المطلوب. {INDEX_LINK_HTML}</p>
                    <p class="mt-1">الفهرس المطلوب غالبًا ما يكون على مجموعة 'establishments' للحقول 'status' (تصاعدي)، '{KEY_FIELD}' (تصاعدي أو 'in') و 'publishedAt' (تنازلي).</p>
                    <p class="mt-2">بعد إنشاء الفهرس، قد يستغرق الأمر بضع دقائق حتى يتم تفعيله. يرجى تحديث الصفحة بعد ذلك.</p>
                </div>`,
                en: `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <h3 class="font-bold">Database Error!</h3>
                    <p>The query requires an index not found in Firestore.</p>
                    <p class="mt-2"><strong>Solution:</strong> Please go to your Firebase project console and create the required index. {INDEX_LINK_HTML}</p>
                    <p class="mt-1">The required index is often on the 'establishments' collection for the fields 'status' (ascending), '{KEY_FIELD}' (ascending or 'in'), and 'publishedAt' (descending).</p>
                    <p class="mt-2">After creating the index, it may take a few minutes to activate. Please refresh the page afterwards.</p>
                </div>`,
                es: `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <h3 class="font-bold">¡Error de Base de Datos!</h3>
                    <p>La consulta requiere un índice que no se encuentra en Firestore.</p>
                    <p class="mt-2"><strong>Solución:</strong> Ve a la consola de tu proyecto de Firebase y crea el índice requerido. {INDEX_LINK_HTML}</p>
                    <p class="mt-1">El índice requerido suele estar en la colección 'establishments' para los campos 'status' (ascendente), '{KEY_FIELD}' (ascendente o 'in') y 'publishedAt' (descendente).</p>
                    <p class="mt-2">Después de crear el índice, puede tardar unos minutos en activarse. Actualiza la página después.</p>
                </div>`,
                de: `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <h3 class="font-bold">Datenbankfehler!</h3>
                    <p>Die Abfrage erfordert einen Index, der in Firestore nicht gefunden wurde.</p>
                    <p class="mt-2"><strong>Lösung:</strong> Bitte gehen Sie zu Ihrer Firebase-Projektkonsole und erstellen Sie den erforderlichen Index. {INDEX_LINK_HTML}</p>
                    <p class="mt-1">Der erforderliche Index befindet sich häufig in der Sammlung 'establishments' für die Felder 'status' (aufsteigend), '{KEY_FIELD}' (aufsteigend oder 'in') und 'publishedAt' (absteigend).</p>
                    <p class="mt-2">Nach dem Erstellen des Indexes kann es einige Minuten dauern, bis er aktiviert wird. Bitte aktualisieren Sie die Seite anschließend.</p>
                </div>`,
                tr: `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <h3 class="font-bold">Veritabanı Hatası!</h3>
                    <p>Sorgu, Firestore'da bulunmayan bir dizin gerektiriyor.</p>
                    <p class="mt-2"><strong>Çözüm:</strong> Lütfen Firebase proje konsolunuza gidin ve gerekli dizini oluşturun. {INDEX_LINK_HTML}</p>
                    <p class="mt-1">Gerekli dizin genellikle 'establishments' koleksiyonunda 'status' (artan), '{KEY_FIELD}' (artan veya 'in') ve 'publishedAt' (azalan) alanları içindir.</p>
                    <p class="mt-2">Dizini oluşturduktan sonra etkinleşmesi birkaç dakika sürebilir. Lütfen daha sonra sayfayı yenileyin.</p>
                </div>`
            },
            "error_query_setup": { ar: "خطأ فادح في إعداد الاستعلام:", en: "Fatal error setting up query:", es: "Error fatal al configurar la consulta:", de: "Schwerwiegender Fehler beim Einrichten der Abfrage:", tr: "Sorgu ayarlanırken önemli hata:" },
            "image_load_error_placeholder_text": { ar: "خطأ في تحميل الصورة", en: "Image Load Error", es: "Error al Cargar Imagen", de: "Bildladefehler", tr: "Resim Yükleme Hatası" },
            "error_loading_map": { ar: "خطأ في تحميل الخريطة.", en: "Error loading map.", es: "Error al cargar el mapa.", de: "Fehler beim Laden der Karte.", tr: "Harita yüklenirken hata oluştu." },
            "complaints_suggestions_modal_title": { ar: "شكاوى واقتراحات", en: "Complaints & Suggestions", es: "Quejas y Sugerencias", de: "Beschwerden & Vorschläge", tr: "Şikayet & Öneriler" },
            "complaints_email_text": { ar: "لتقديم شكوى أو اقتراح، يرجى مراسلتنا على البريد الإلكتروني التالي:", en: "To submit a complaint or suggestion, please email us at:", es: "Para enviar una queja o sugerencia, envíenos un correo electrónico a:", de: "Um eine Beschwerde oder einen Vorschlag einzureichen, senden Sie uns bitte eine E-Mail an:", tr: "Bir şikayet veya öneri göndermek için lütfen bize şu adresten e-posta gönderin:" },
            "copy_email_btn": { ar: "نسخ البريد الإلكتروني", en: "Copy Email", es: "Copiar Correo Electrónico", de: "E-Mail Kopieren", tr: "E-postayı Kopyala" },
            "email_copied_alert": { ar: "تم نسخ البريد الإلكتروني!", en: "Email copied!", es: "¡Correo electrónico copiado!", de: "E-Mail kopiert!", tr: "E-posta kopyalandı!" },
            "syria_vpn_notice_title": { ar: "تنبيه هام للمستخدمين في سوريا", en: "Important Notice for Users in Syria", es: "Aviso Importante para Usuarios en Siria", de: "Wichtiger Hinweis für Benutzer in Syrien", tr: "Suriye'deki Kullanıcılar İçin Önemli Duyuru" },
            "syria_vpn_notice_text": { ar: "نأسف لإبلاغكم بأن خدماتنا غير متاحة حاليًا بشكل مباشر في سوريا. للوصول إلى التطبيق، يرجى استخدام خدمة VPN أو بروكسي من دولة أخرى. نقدر تفهمكم.", en: "We regret to inform you that our services are currently not directly available in Syria. To access the application, please use a VPN or proxy service from another country. We appreciate your understanding.", es: "Lamentamos informarle que nuestros servicios no están disponibles directamente en Siria en este momento. Para acceder a la aplicación, utilice un servicio de VPN o proxy de otro país. Agradecemos su comprensión.", de: "Wir bedauern, Ihnen mitteilen zu müssen, dass unsere Dienste derzeit in Syrien nicht direkt verfügbar sind. Um auf die Anwendung zuzugreifen, verwenden Sie bitte einen VPN- oder Proxy-Dienst aus einem anderen Land. Wir bitten um Ihr Verständnis.", tr: "Hizmetlerimizin şu anda Suriye'de doğrudan kullanılamadığını bildirmekten üzüntü duyarız. Uygulamaya erişmek için lütfen başka bir ülkeden bir VPN veya proxy hizmeti kullanın. Anlayışınız için teşekkür ederiz." },
            "syria_vpn_notice_confirm_btn": { ar: "فهمت", en: "Understood", es: "Entendido", de: "Verstanden", tr: "Anladım" }
        };

        function getCurrentLanguage() {
            return localStorage.getItem('selectedLanguage') || 'ar';
        }

        function getTranslation(key, lang = null) {
            const effectiveLang = lang || getCurrentLanguage();
            return translations[key]?.[effectiveLang] || translations[key]?.['ar'] || key; // Fallback to Arabic, then key itself
        }
        
        function getDynamicTranslation(key, dynamicValue, lang = null) {
            const effectiveLang = lang || getCurrentLanguage();
            let template = translations[key]?.[effectiveLang] || translations[key]?.['ar'] || key;
            if (typeof template === 'string' && dynamicValue) {
                for (const placeholder in dynamicValue) {
                    template = template.replace(`{${placeholder}}`, dynamicValue[placeholder]);
                }
            }
            return template;
        }


        function getTranslatedFieldValue(fieldObject, lang, defaultLang = 'ar') {
            if (typeof fieldObject === 'object' && fieldObject !== null) {
                // Prioritize current lang, then default lang, then first available truthy value, then empty string
                return fieldObject[lang] || fieldObject[defaultLang] || Object.values(fieldObject).find(val => val) || '';
            }
            return fieldObject || ''; // Fallback for old data or non-translatable fields
        }
        
        function applyTranslationsToUI() {
            const lang = getCurrentLanguage();
            const langObj = supportedLanguages.find(l => l.code === lang) || supportedLanguages[0]; // Fallback to Arabic if lang not found
            
            document.documentElement.lang = langObj.code;
            document.documentElement.dir = langObj.dir;

            document.title = getTranslation("app_title");

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = getTranslation(key, lang);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.placeholder && el.dataset.translatePlaceholder) el.placeholder = translation; // Only translate if placeholder is marked
                    else if (el.placeholder && !el.dataset.translatePlaceholder) { /* do nothing if not marked */ }
                    else if (el.type === 'submit' || el.type === 'button') el.value = translation;
                } else if (el.tagName === 'BUTTON' && el.dataset.translateContent) {
                     // For buttons with icons, translate only text node
                    Array.from(el.childNodes).forEach(child => {
                        if (child.nodeType === Node.TEXT_NODE && child.textContent.trim() !== '') {
                            child.textContent = translation;
                        }
                    });
                } else {
                    el.innerHTML = translation; // Use innerHTML for elements that might contain spans from translation
                }
            });
             // Translate placeholders specifically marked with data-translate-placeholder
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                el.placeholder = getTranslation(key, lang);
            });
            
            // Specific complex elements
            const userAuthStatusDiv = document.getElementById('user-auth-status');
            if (userAuthStatusDiv && auth && auth.currentUser) { // Check if auth is initialized
                 if (auth.currentUser.isAnonymous) {
                    userAuthStatusDiv.innerHTML = `${getTranslation('user_auth_status_anonymous', lang)} <i class="fas fa-user-secret text-gray-400"></i>`;
                } else {
                    userAuthStatusDiv.innerHTML = `<span class="font-semibold">${auth.currentUser.email || getTranslation('user_auth_status_current_user', lang)}</span> <i class="fas fa-user-check text-green-400"></i>`;
                }
            } else if (userAuthStatusDiv) {
                 userAuthStatusDiv.innerHTML = `${getTranslation('user_auth_status_visitor', lang)} <i class="fas fa-user-secret text-gray-400"></i>`;
            }


            // Buttons with icons - need careful handling if text is not the only child
            const buttonsToTranslate = [
                { id: 'login-register-btn', key: 'login_register_btn', iconClass: 'fa-sign-in-alt' },
                { id: 'open-add-establishment-modal-btn', key: 'add_establishment_btn', iconClass: 'fa-plus-circle' },
                { id: 'show-my-establishments-btn', key: 'my_establishments_btn', iconClass: 'fa-store' },
                { id: 'open-manage-paid-ads-modal-btn', key: 'manage_paid_ads_btn', iconClass: 'fa-ad' },
                { id: 'logout-btn', key: 'logout_btn', iconClass: 'fa-sign-out-alt' },
                { id: 'locate-user-btn', key: 'locate_user_btn_map', iconClass: 'fa-location-arrow' }
                // Add other buttons here if they follow the same pattern
            ];

            buttonsToTranslate.forEach(btnInfo => {
                const btnElement = document.getElementById(btnInfo.id);
                if (btnElement) {
                    const iconElement = btnElement.querySelector(`i.${btnInfo.iconClass.replace(' ', '.')}`); // Handle multiple classes if any
                    let iconHTML = '';
                    if (iconElement) {
                        iconHTML = iconElement.outerHTML + (langObj.dir === 'ltr' ? ' ' : ''); // Space after icon for LTR, no space for RTL
                    }
                    const text = getTranslation(btnInfo.key, lang);
                    // Place icon first in LTR, text first in RTL if icon exists
                    btnElement.innerHTML = (langObj.dir === 'rtl' && iconElement) ? `${text} ${iconHTML}` : `${iconHTML}${text}`;
                }
            });


            populateFilters(); // Repopulate with translated options
            if (initialAuthCheckCompleted) { // Avoid premature loading
                loadEstablishments();
                loadPaidAds();
            }
        }

        function setCurrentLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('selectedLanguage', lang);
            applyTranslationsToUI(); // This will re-render UI elements, including filters and data
        }
        // --- End Language and Translation ---


        try {
            app = initializeApp(firebaseConfig);
            setLogLevel('debug'); // Set to 'debug' for development, 'warn' or 'error' for production
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app); // Initialize Analytics
            console.log("Firebase initialized successfully with Analytics. Debug logging enabled.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            const mainContent = document.getElementById('main-content-area');
            if (mainContent) {
                mainContent.innerHTML = `<p class="text-red-600 text-center p-5 bg-red-50 rounded-lg">${getTranslation("error_firebase_init")}</p>`;
            }
            // Potentially display a user-friendly message on the page
        }

        function updateUIAfterAuthChange(user) {
            const addEstablishmentBtnContainer = document.getElementById('add-establishment-btn-container');
            const managePaidAdsBtnContainer = document.getElementById('manage-paid-ads-btn-container');
            const myEstablishmentsBtnContainer = document.getElementById('my-establishments-btn-container');
            const userAuthStatusDiv = document.getElementById('user-auth-status');
            const loginRegisterBtn = document.getElementById('login-register-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const lang = getCurrentLanguage(); // Get current language for translations

            if (user) {
                userId = user.uid;
                if (user.isAnonymous) {
                    userAuthStatusDiv.innerHTML = `${getTranslation('user_auth_status_anonymous', lang)} <i class="fas fa-user-secret text-gray-400"></i>`;
                } else {
                    userAuthStatusDiv.innerHTML = `<span class="font-semibold">${user.email || getTranslation('user_auth_status_current_user', lang)}</span> <i class="fas fa-user-check text-green-400"></i>`;
                }
                loginRegisterBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');

                // Fetch user role if not anonymous
                if (!user.isAnonymous) {
                    // Path to user profile: /artifacts/{appId}/users/{userId}/profile/info
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
                    getDoc(userProfileRef).then(userProfileSnap => {
                        if (userProfileSnap.exists()) {
                            userRole = userProfileSnap.data().role;
                            console.log("Auth: User profile fetched. Role:", userRole);
                            if (userRole === 'investor') {
                                addEstablishmentBtnContainer?.classList.remove('hidden');
                                myEstablishmentsBtnContainer?.classList.remove('hidden');
                            } else {
                                addEstablishmentBtnContainer?.classList.add('hidden');
                                myEstablishmentsBtnContainer?.classList.add('hidden');
                            }
                            // Admin check (example)
                            if (user.email === "admin@dalilak.com") { // Replace with actual admin check logic
                                managePaidAdsBtnContainer?.classList.remove('hidden');
                            } else {
                                managePaidAdsBtnContainer?.classList.add('hidden');
                            }
                        } else {
                            console.warn("Auth: User profile document not found for UID:", userId);
                            userRole = 'visitor'; // Default to visitor if profile not found
                            addEstablishmentBtnContainer?.classList.add('hidden');
                            myEstablishmentsBtnContainer?.classList.add('hidden');
                            managePaidAdsBtnContainer?.classList.add('hidden');
                        }
                        loadAppInitialData(); // Load data after role is determined
                    }).catch(profileError => {
                        console.error("Auth: Error fetching user profile.", profileError);
                        userRole = null; // Or 'visitor' as a fallback
                        addEstablishmentBtnContainer?.classList.add('hidden');
                        myEstablishmentsBtnContainer?.classList.add('hidden');
                        managePaidAdsBtnContainer?.classList.add('hidden');
                        loadAppInitialData(); // Still load public data
                    });
                } else {
                     userRole = 'visitor'; // Anonymous users are visitors
                     console.log("Auth: User is anonymous, assigned role 'visitor'.");
                     addEstablishmentBtnContainer?.classList.add('hidden');
                     myEstablishmentsBtnContainer?.classList.add('hidden');
                     managePaidAdsBtnContainer?.classList.add('hidden');
                     loadAppInitialData(); // Load data for anonymous user
                }
            } else {
                // No user is signed in (or user has just logged out)
                userId = null;
                userRole = null;
                console.log("Auth: No user currently signed in (or user has just logged out). UI updated for visitor.");
                userAuthStatusDiv.innerHTML = `${getTranslation('user_auth_status_visitor', lang)} <i class="fas fa-user-secret text-gray-400"></i>`;
                loginRegisterBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                addEstablishmentBtnContainer?.classList.add('hidden');
                myEstablishmentsBtnContainer?.classList.add('hidden');
                managePaidAdsBtnContainer?.classList.add('hidden');
                loadAppInitialData(); // Load public data
            }
        }


        onAuthStateChanged(auth, async (user) => {
            console.log("Auth: onAuthStateChanged triggered. User object:", user);
            isAuthDataLoaded = false; // Reset flag to allow data reload if necessary for the new auth state

            if (user) {
                // User is signed in (either regular or anonymous)
                initialAuthCheckCompleted = true; // Mark that initial check is done
                updateUIAfterAuthChange(user);
            } else {
                // No user is signed in. This block runs on initial load if no one is logged in,
                // or after a user signs out.
                if (!initialAuthCheckCompleted) {
                    // This is the very first auth check on app load, and no user was found.
                    // Attempt to sign in anonymously.
                    initialAuthCheckCompleted = true; // Mark that initial check is done
                    console.log("Auth: Initial app load & no active user. Attempting auto anonymous sign-in...");
                    try {
                        console.log("Auth: Attempting auto anonymous sign-in.");
                        await signInAnonymously(auth);
                        // onAuthStateChanged will re-trigger with the new anonymous user.
                        // updateUIAfterAuthChange will be called then.
                        console.log("Auth: Auto anonymous sign-in successful. onAuthStateChanged will re-trigger with the new anonymous user.");
                    } catch (anonError) {
                        console.error("Auth: Auto anonymous sign-in FAILED.", anonError);
                        const lang = getCurrentLanguage();
                        // Handle specific error if anonymous auth is not enabled in Firebase console
                        if (anonError.code === 'auth/configuration-not-found' || anonError.code === 'auth/operation-not-allowed') {
                            console.error("CRITICAL AUTH ERROR: Anonymous sign-in failed due to 'auth/configuration-not-found' or 'auth/operation-not-allowed'. PLEASE ENABLE ANONYMOUS AUTHENTICATION IN YOUR FIREBASE PROJECT.");
                            document.getElementById('user-auth-status').innerHTML = `<span class="text-red-500">${getTranslation('auth_error_anon_signin_disabled', lang)}</span>`;
                        } else {
                             document.getElementById('user-auth-status').innerHTML = `<span class="text-red-500">${getTranslation('auth_error_initial_failed', lang)}</span>`;
                        }
                        console.log("Auth: Anonymous sign-in attempt failed. Proceeding without an authenticated user for now. Public data should still load.");
                        updateUIAfterAuthChange(null); // Update UI for a non-logged-in state
                    }
                } else {
                    // User has explicitly signed out (initialAuthCheckCompleted was true)
                    console.log("Auth: User has explicitly signed out. auth.currentUser is null. UI will be updated for visitor state. Ready for new login/registration.");
                    updateUIAfterAuthChange(null);
                }
            }
        });

        // Function to load initial app data (establishments, ads)
        // This should be called after auth state is known (especially after role is determined for logged-in users)
        function loadAppInitialData() {
            if (!isAuthDataLoaded) { // Only load if not already loaded for the current auth state
                console.log("DataLoad: Loading app data (establishments, paid ads).");
                isAuthDataLoaded = true;
                loadEstablishments();
                loadPaidAds();
                initializeMainMap(); // Initialize map after other content if it depends on it or for better perceived performance
            } else {
                 console.log("DataLoad: App data already loaded for current auth state or load in progress.");
            }
        }

        function initializeMainMap() {
            console.log("Map: Attempting to initialize main map.");
            const mapContainer = document.getElementById('main-map-container');
            if (mapContainer && !mainMap) { // Initialize only if container exists and map not already initialized
                try {
                    mainMap = L.map(mapContainer, {
                        scrollWheelZoom: true // Allow scroll wheel zoom
                    }).setView([35.0, 38.0], 6); // Default view for Syria
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 18,
                    }).addTo(mainMap);
                    console.log("Map: Main map initialized.");

                    // Locate user button functionality
                    const locateUserBtn = document.getElementById('locate-user-btn');
                    if (locateUserBtn) {
                        locateUserBtn.addEventListener('click', () => {
                            if (navigator.geolocation) {
                                console.log("Map: Locate button clicked. Requesting user location.");
                                Swal.showLoading(); // Show loading indicator
                                navigator.geolocation.getCurrentPosition(position => {
                                    Swal.close(); // Close loading indicator
                                    const userLat = position.coords.latitude;
                                    const userLng = position.coords.longitude;
                                    console.log(`Map: User location found: Lat: ${userLat}, Lng: ${userLng}`);
                                    if (userMarker) mainMap.removeLayer(userMarker); // Remove old marker
                                    userMarker = L.marker([userLat, userLng], {
                                        icon: L.icon({ // Custom blue marker for user
                                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', shadowSize: [41, 41]
                                        })
                                    }).addTo(mainMap)
                                        .bindPopup(`<b>${getTranslation('map_marker_your_location')}</b>`)
                                        .openPopup();
                                    mainMap.setView([userLat, userLng], 13); // Zoom to user location
                                }, (error) => {
                                    Swal.close(); // Close loading indicator
                                    console.warn("Map: User denied geolocation or error occurred.", error.message);
                                    Swal.fire(getTranslation('establishment_details_error_title'), getTranslation('map_marker_error_locating'), 'warning');
                                });
                            } else {
                                console.warn("Map: Geolocation is not supported by this browser.");
                                Swal.fire(getTranslation('establishment_details_error_title'), getTranslation('map_marker_geolocation_not_supported'), 'warning');
                            }
                        });
                    }

                } catch(e) {
                    console.error("Map: Error initializing Leaflet map:", e);
                    mapContainer.innerHTML = `<p class="text-center text-red-500 p-4">${getTranslation('error_loading_map')}</p>`;
                }
            } else if (mainMap) {
                 console.log("Map: Main map already initialized.");
            } else {
                console.warn("Map: main-map-container not found. Map initialization skipped.");
            }
        }


        // DOM Elements
        const establishmentsContainer = document.getElementById('establishments-container');
        const paidAdsBanner = document.getElementById('paid-ads-banner');
        const categoryFilter = document.getElementById('category-filter');
        const governorateFilter = document.getElementById('governorate-filter');
        const nameSearchInput = document.getElementById('name-search-input'); // Added for name search
        const applyFiltersBtn = document.getElementById('apply-filters-btn'); // Added for applying all filters
        const loadingIndicator = document.getElementById('loading-indicator');
        const noResultsMessage = document.getElementById('no-results-message');

        // Define canonical keys for categories and governorates (used as values in dropdowns)
        const categoryKeys = ["all", "restaurant", "hotel", "cafe", "beach", "mountain", "forest", "museum", "pool", "river", "archaeological_site", "park", "popular_market", "other"];
        const governorateKeys = [
            "all", "damascus", "rif_dimashq", "aleppo", "homs", "hama", "lattakia", "tartus",
            "deir_ezzor", "alhasakah", "alraqqah", "idlib", "alsuweida", "daraa", "alqunaytirah"
        ];


        // Populate filter dropdowns
        function populateFilters() {
            if (!categoryFilter || !governorateFilter) return; // Ensure elements exist
            const lang = getCurrentLanguage();
            categoryFilter.innerHTML = ''; // Clear existing options
            governorateFilter.innerHTML = '';

            categoryKeys.forEach(catKey => {
                const option = document.createElement('option');
                option.value = catKey === "all" ? "" : catKey; // Store canonical key as value
                option.textContent = getTranslation(catKey, lang); // Display translated text
                categoryFilter.appendChild(option);
            });
            governorateKeys.forEach(govKey => {
                const option = document.createElement('option');
                option.value = govKey === "all" ? "" : govKey; // Store canonical key as value
                option.textContent = getTranslation(govKey, lang); // Display translated text
                governorateFilter.appendChild(option);
            });
        }

        // Load establishments from Firestore
        async function loadEstablishments(filterByOwnerId = null) {
             if (!initialAuthCheckCompleted) {
                 console.warn("LoadEstablishments: Initial auth check not yet completed. Deferring load.");
                 return;
            }
            if (!db || !establishmentsContainer) {
                 console.error("LoadEstablishments: DB not initialized or container not found.");
                 return;
            }
            const lang = getCurrentLanguage();
            console.log("LoadEstablishments: Called.", filterByOwnerId ? `Filtering for owner: ${filterByOwnerId}` : "Loading all approved.");
            showLoading(true);
            establishmentsContainer.innerHTML = ''; 
            noResultsMessage.classList.add('hidden'); 
            document.getElementById('main-content-area-title').textContent = filterByOwnerId ? getTranslation("my_establishments_page_title", lang) : getTranslation("latest_establishments_title", lang);


            const selectedCategoryCanonicalKey = categoryFilter.value;
            const selectedGovernorateCanonicalKey = governorateFilter.value;
            const searchNameTerm = nameSearchInput.value.trim().toLowerCase(); // Get search term for name

            try {
                const publicEstablishmentsPath = `artifacts/${appId}/public/data/establishments`;
                let queryConstraints = [];

                if (filterByOwnerId) {
                    queryConstraints.push(where("ownerId", "==", filterByOwnerId));
                } else {
                    queryConstraints.push(where("status", "==", "approved")); 

                    if (selectedCategoryCanonicalKey) {
                        queryConstraints.push(where("categoryKey", "==", selectedCategoryCanonicalKey));
                        console.log("Filtering by categoryKey EQUALS:", selectedCategoryCanonicalKey);
                    }

                    if (selectedGovernorateCanonicalKey) {
                        queryConstraints.push(where("governorateKey", "==", selectedGovernorateCanonicalKey));
                        console.log("Filtering by governorateKey EQUALS:", selectedGovernorateCanonicalKey);
                    }
                }

                queryConstraints.push(orderBy("publishedAt", "desc")); 
                queryConstraints.push(limit(filterByOwnerId ? 100 : 150)); 

                const q = query(collection(db, publicEstablishmentsPath), ...queryConstraints);

                if (establishmentsListener) establishmentsListener();

                establishmentsListener = onSnapshot(q, (querySnapshot) => {
                    showLoading(false);
                    let establishmentDocs = [];
                    establishmentMarkers.forEach(marker => mainMap?.removeLayer(marker));
                    establishmentMarkers = [];

                    querySnapshot.forEach((doc) => {
                        const establishmentData = doc.data();
                        if (searchNameTerm && !filterByOwnerId) { 
                            const nameAr = (establishmentData.name?.ar || "").toLowerCase();
                            const nameEn = (establishmentData.name?.en || "").toLowerCase();
                            // More robust search: check if any translated name contains the search term
                            let nameMatches = false;
                            if (establishmentData.name && typeof establishmentData.name === 'object') {
                                for (const langCode in establishmentData.name) {
                                    if (establishmentData.name[langCode].toLowerCase().includes(searchNameTerm)) {
                                        nameMatches = true;
                                        break;
                                    }
                                }
                            }
                            if (!nameMatches) {
                                return; 
                            }
                        }
                        establishmentDocs.push({ id: doc.id, data: establishmentData });

                        if (establishmentData.coordinates && typeof establishmentData.coordinates.latitude === 'number' && typeof establishmentData.coordinates.longitude === 'number' && mainMap) {
                            const estMarker = L.marker([establishmentData.coordinates.latitude, establishmentData.coordinates.longitude], {
                                 icon: L.icon({ 
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', shadowSize: [41, 41]
                                })
                            })
                                .addTo(mainMap)
                                .bindPopup(`<b>${getTranslatedFieldValue(establishmentData.name, lang)}</b><br>${getTranslation(establishmentData.categoryKey, lang) || ''}<br><button class="text-indigo-600 hover:underline text-xs mt-1 show-details-btn-map" data-id="${doc.id}">${getTranslation("view_details_btn", lang)}</button>`);
                            establishmentMarkers.push(estMarker);
                        }
                    });

                    establishmentsContainer.innerHTML = ''; 
                    if (establishmentDocs.length === 0) {
                        noResultsMessage.classList.remove('hidden');
                        return;
                    }
                    establishmentDocs.forEach(docInfo => renderEstablishmentCard(docInfo.id, docInfo.data));
                }, (error) => {
                    console.error("LoadEstablishments: Error in onSnapshot.", error);
                    showLoading(false);
                    let errorMessageText = getDynamicTranslation("error_loading_establishments", { message: error.message }, lang);
                    if (error.code === 'failed-precondition' && error.message.toLowerCase().includes('index')) {
                        const indexCreationLinkMatch = error.message.match(/https:\/\/console\.firebase\.google\.com\/v1\/r\/project\/[^/]+\/firestore\/indexes\?create_composite=[^\s]+/);
                        const indexCreationLink = indexCreationLinkMatch ? indexCreationLinkMatch[0] : null;
                        const indexLinkHtml = indexCreationLink ? `يمكنك محاولة استخدام <a href="${indexCreationLink}" target="_blank" class="font-bold text-blue-600 hover:underline">هذا الرابط</a> لإنشائه.` : 'عادةً ما توفر رسالة الخطأ في وحدة تحكم المتصفح رابطًا مباشرًا لإنشاء هذا الفهرس.';
                        
                        let keyField = "categoryKey or governorateKey"; 
                        if (selectedCategoryCanonicalKey && selectedGovernorateCanonicalKey) keyField = "categoryKey' and 'governorateKey";
                        else if (selectedCategoryCanonicalKey) keyField = "categoryKey";
                        else if (selectedGovernorateCanonicalKey) keyField = "governorateKey";

                        errorMessageText = getDynamicTranslation("error_firestore_index_required", { INDEX_LINK_HTML: indexLinkHtml, KEY_FIELD: keyField }, lang);
                        establishmentsContainer.innerHTML = errorMessageText; 
                    } else {
                         establishmentsContainer.innerHTML = `<p class="text-red-600 p-4 bg-red-50 rounded-md">${errorMessageText}</p>`;
                    }
                });
            } catch (error) {
                console.error("LoadEstablishments: Error setting up query.", error);
                showLoading(false);
                establishmentsContainer.innerHTML = `<p class="text-red-600 p-4 bg-red-50 rounded-md">${getDynamicTranslation("error_query_setup", { message: error.message }, lang)}</p>`;
            }
        }


        // Render a single establishment card
        function renderEstablishmentCard(id, data) {
            const lang = getCurrentLanguage();
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 ease-in-out flex flex-col group'; 

            const name = getTranslatedFieldValue(data.name, lang) || getTranslation("establishment_name_not_available", lang);
            const descriptionText = getTranslatedFieldValue(data.description, lang);
            const description = descriptionText.substring(0, 120).replace(/</g, "&lt;").replace(/>/g, "&gt;") + (descriptionText.length > 120 ? '...' : '') || getTranslation("no_description", lang) ;

            const imageUrl = data.photos && data.photos.length > 0 && typeof data.photos[0] === 'string' && data.photos[0].startsWith('data:image')
                             ? data.photos[0]
                             : `https://placehold.co/600x400/E2E8F0/4A5568?text=${encodeURIComponent(name)}&font=cairo`; 
            const averageRating = data.averageRating ? parseFloat(data.averageRating).toFixed(1) : '0.0';
            const ratingCount = data.ratingCount || 0;
            const categoryDisplay = data.categoryKey ? getTranslation(data.categoryKey, lang) : getTranslation("category_placeholder_card", lang);
            const governorateDisplay = data.governorateKey ? getTranslation(data.governorateKey, lang) : getTranslation("governorate_not_specified", lang);


            card.innerHTML = `
                <div class="relative">
                    <img src="${imageUrl}" alt="${name}" class="w-full h-56 object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/4A5568?text=${getTranslation("image_load_error_placeholder_text", lang)}&font=cairo';">
                    <div class="absolute top-2 ${lang === 'ar' ? 'right-2' : 'left-2'} bg-indigo-600 text-white text-xs font-semibold px-2.5 py-1 rounded-full shadow-md">${categoryDisplay}</div>
                    ${data.status === 'pending' ? `<div class="absolute top-2 ${lang === 'ar' ? 'left-2' : 'right-2'} bg-yellow-400 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full shadow-md">${getTranslation("pending_review_badge", lang)}</div>` : ''}
                     ${data.paidAdRequestStatus === 'pending' ? `<div class="absolute bottom-2 ${lang === 'ar' ? 'left-2' : 'right-2'} bg-orange-400 text-orange-800 text-xs font-semibold px-2.5 py-1 rounded-full shadow-md">${getTranslation("paid_ad_request_badge", lang)}</div>` : ''}
                </div>
                <div class="p-5 flex flex-col flex-grow"> <h3 class="text-xl lg:text-2xl font-bold text-gray-800 group-hover:text-indigo-600 transition-colors duration-300 mb-2">${name}</h3>
                    <p class="text-gray-600 text-sm mb-3 flex-grow leading-relaxed">${description}</p> <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <span class="flex items-center">
                            <i class="fas fa-star text-amber-400 ${lang === 'ar' ? 'ml-1' : 'mr-1'}"></i>
                            <span class="font-bold text-amber-500">${averageRating}</span>
                            <span class="mx-1 text-gray-400">(${ratingCount} ${getTranslation("ratings_count_text", lang)})</span>
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-map-marker-alt text-red-500 ${lang === 'ar' ? 'ml-1' : 'mr-1'}"></i> ${governorateDisplay}
                        </span>
                    </div>
                     <button data-establishment-id="${id}" class="show-details-btn btn-primary w-full text-base mt-auto"> <i class="fas fa-info-circle ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("view_details_btn", lang)}
                     </button>
                </div>
            `;
            if (establishmentsContainer) establishmentsContainer.appendChild(card);
        }

        // Show establishment details in a SweetAlert modal
        window.showEstablishmentDetails = async (establishmentId) => {
             const lang = getCurrentLanguage();
             try {
                // Path to public establishment data
                const establishmentRef = doc(db, `artifacts/${appId}/public/data/establishments`, establishmentId);
                const docSnap = await getDoc(establishmentRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const name = getTranslatedFieldValue(data.name, lang) || getTranslation("establishment_name_not_available", lang);
                    const description = getTranslatedFieldValue(data.description, lang) || getTranslation("no_description", lang);
                    const locationText = getTranslatedFieldValue(data.location, lang) || getTranslation("governorate_not_specified", lang); 
                    const priceRangeText = getTranslatedFieldValue(data.priceRange, lang) || ''; 

                    const averageRating = data.averageRating ? parseFloat(data.averageRating).toFixed(1) : '0.0';
                    const ratingCount = data.ratingCount || 0;
                    const isOwner = auth.currentUser && auth.currentUser.uid === data.ownerId;

                    let photosHtml = `<div class="grid grid-cols-1 sm:grid-cols-${Math.min(data.photos?.length || 1, 2)} gap-2 my-3">`; 
                    if (data.photos && data.photos.length > 0) {
                        data.photos.slice(0,2).forEach(photoDataUrl => { 
                            if (typeof photoDataUrl === 'string' && photoDataUrl.startsWith('data:image')) { 
                                photosHtml += `<img src="${photoDataUrl}" alt="${name}" class="w-full h-40 object-cover rounded-md shadow-sm" onerror="this.style.display='none';">`;
                            }
                        });
                    } else {
                         photosHtml += `<img src="https://placehold.co/300x200/E2E8F0/4A5568?text=${encodeURIComponent(name)}&font=cairo" alt="${name}" class="w-full h-40 object-cover rounded-md shadow-sm col-span-full" onerror="this.style.display='none';">`; 
                    }
                    photosHtml += '</div>';

                    let requestAdButtonHtml = '';
                    if (isOwner && data.status === 'approved' && !data.isPaidAd && data.paidAdRequestStatus !== 'pending') {
                        requestAdButtonHtml = `<button id="swal-request-paid-ad-btn-${establishmentId}" class="btn-secondary text-sm py-2 mt-3 w-full"><i class="fas fa-bullhorn ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("request_featured_ad_btn_details", lang)}</button>`;
                    } else if (isOwner && data.paidAdRequestStatus === 'pending') {
                        requestAdButtonHtml = `<p class="text-sm text-orange-500 mt-3 p-2 bg-orange-50 rounded-md"><i class="fas fa-clock ${lang === 'ar' ? 'ml-1' : 'mr-1'}"></i> ${getTranslation("featured_ad_request_pending_text", lang)}</p>`;
                    } else if (data.isPaidAd) {
                         requestAdButtonHtml = `<p class="text-sm text-green-500 mt-3 p-2 bg-green-50 rounded-md"><i class="fas fa-check-circle ${lang === 'ar' ? 'ml-1' : 'mr-1'}"></i> ${getTranslation("is_featured_ad_text", lang)}</p>`;
                    }


                    const swalHtml = `
                        <div class="text-${lang === 'ar' ? 'right' : 'left'}">
                            ${photosHtml}
                            <p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("description_details_label", lang)}</strong> ${description}</p>
                            <p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("governorate_details_label", lang)}</strong> ${data.governorateKey ? getTranslation(data.governorateKey, lang) : getTranslation("governorate_not_specified", lang)}</p>
                            <p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("category_details_label", lang)}</strong> ${data.categoryKey ? getTranslation(data.categoryKey, lang) : getTranslation("category_placeholder_card", lang)}</p>
                            <p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("location_text_details_label", lang)}</strong> ${locationText}</p>
                            ${data.coordinates ? `<p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("coordinates_details_label", lang)}</strong> ${data.coordinates.latitude.toFixed(5)}, ${data.coordinates.longitude.toFixed(5)}</p>` : ''}
                            ${priceRangeText ? `<p class="my-1"><strong class="font-semibold text-gray-700">${getTranslation("price_details_label", lang)}</strong> ${priceRangeText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>` : ''}
                            <p class="text-amber-500 font-bold text-lg my-2"><i class="fas fa-star ${lang === 'ar' ? 'ml-1' : 'mr-1'}"></i> ${getTranslation("rating_details_label", lang)} ${averageRating} (${ratingCount} ${getTranslation("ratings_count_text", lang)})</p>
                            ${requestAdButtonHtml}
                            <div class="mt-4 border-t border-gray-200 pt-3">
                                <h3 class="text-md font-semibold mb-2 text-gray-700">${getTranslation("add_your_rating_title", lang)}</h3>
                                <select id="swal-rating-satisfaction-${establishmentId}" class="swal2-input mb-2 w-full p-2 border rounded">
                                    <option value="5">⭐⭐⭐⭐⭐ (${getTranslation("rating_excellent", lang)})</option>
                                    <option value="4">⭐⭐⭐⭐ (${getTranslation("rating_very_good", lang)})</option>
                                    <option value="3" selected>⭐⭐⭐ (${getTranslation("rating_good", lang)})</option>
                                    <option value="2">⭐⭐ (${getTranslation("rating_fair", lang)})</option>
                                    <option value="1">⭐ (${getTranslation("rating_poor", lang)})</option>
                                </select>
                                <textarea id="swal-rating-comment-${establishmentId}" class="swal2-textarea mb-2 w-full p-2 border rounded" rows="2" placeholder="${getTranslation("rating_comment_placeholder", lang)}"></textarea>
                                <button id="swal-submit-rating-btn-${establishmentId}" class="swal2-confirm swal2-styled bg-green-500 hover:bg-green-600" style="background-color: #28a745;">${getTranslation("submit_rating_btn", lang)}</button>
                                <div id="swal-submit-rating-feedback-${establishmentId}" class="text-sm mt-1"></div>
                            </div>
                            <div id="swal-ratings-list-${establishmentId}" class="mt-3 pt-3 border-t border-gray-200 max-h-40 overflow-y-auto">
                                </div>
                        </div>
                    `;

                    Swal.fire({
                        title: `<strong class="text-2xl text-indigo-600">${name}</strong>`,
                        html: swalHtml,
                        showCloseButton: true,
                        showConfirmButton: false, 
                        width: '90%', 
                        maxWidth: '600px', 
                        didOpen: () => {
                            const submitBtn = document.getElementById(`swal-submit-rating-btn-${establishmentId}`);
                            if(submitBtn) {
                                submitBtn.addEventListener('click', () => submitRating(establishmentId, true)); 
                            }
                            const requestAdBtn = document.getElementById(`swal-request-paid-ad-btn-${establishmentId}`);
                            if(requestAdBtn){
                                requestAdBtn.addEventListener('click', () => requestPaidAd(establishmentId));
                            }
                            loadRatingsForEstablishment(establishmentId, true); 
                        }
                    });

                } else {
                     Swal.fire(getTranslation('establishment_details_error_title', lang), getTranslation('establishment_details_not_found', lang), 'error');
                }
            } catch (error) {
                console.error("Error fetching establishment details for Swal:", error);
                Swal.fire(getTranslation('establishment_details_error_title', lang), `${getTranslation('error_loading_details_text', lang)} ${error.message}`, 'error');
            }
        };

        // Load ratings for a specific establishment
        async function loadRatingsForEstablishment(establishmentId, isSwal = false) {
            const lang = getCurrentLanguage();
            const listIdSuffix = isSwal ? `swal-ratings-list-${establishmentId}` : `ratings-list-${establishmentId}`; 
            const ratingsListDiv = document.getElementById(listIdSuffix);

            if (!ratingsListDiv || !db) return; 
            ratingsListDiv.innerHTML = `<p class="text-gray-500 italic text-xs">${getTranslation("loading_ratings_text", lang)}</p>`;

            try {
                const ratingsPath = `artifacts/${appId}/public/data/ratings`;
                const q = query(collection(db, ratingsPath), where("establishmentId", "==", establishmentId), orderBy("createdAt", "desc"), limit(5)); 

                onSnapshot(q, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        ratingsListDiv.innerHTML = `<p class="text-gray-500 italic text-xs p-1 ${isSwal ? '' : 'bg-gray-50 rounded-md'}">${getTranslation("no_ratings_yet_text", lang)}</p>`;
                        return;
                    }
                    ratingsListDiv.innerHTML = `<h4 class="text-sm font-semibold mb-1 text-gray-600 ${isSwal ? '' : 'text-xl'}">${getTranslation("ratings_list_title", lang)}</h4><div class="space-y-2">`; 
                    querySnapshot.forEach((doc) => {
                        const rating = doc.data();
                        const ratingDiv = document.createElement('div');
                        ratingDiv.className = `p-1.5 ${isSwal ? '' : 'bg-white rounded-lg shadow-sm border border-gray-200'} text-xs`; 
                        const stars = '⭐'.repeat(rating.satisfactionLevel || 0);
                        const comment = rating.comment ? String(rating.comment).replace(/</g, "&lt;").replace(/>/g, "&gt;") : `<em>${getTranslation("no_comment_text", lang)}</em>`; 
                        const visitorName = rating.visitorName ? String(rating.visitorName).replace(/</g, "&lt;").replace(/>/g, "&gt;") : getTranslation("visitor_text", lang); 
                        let date = '';
                        if (rating.createdAt && typeof rating.createdAt.seconds === 'number') { 
                             date = new Date(rating.createdAt.seconds * 1000).toLocaleDateString(lang === 'ar' ? 'ar-SY' : lang, { month: 'short', day: 'numeric' });
                        }

                        ratingDiv.innerHTML = `
                            <div class="flex justify-between items-center mb-0.5">
                                <p class="font-semibold text-gray-700">${visitorName} <span class="text-amber-400 ${lang === 'ar' ? 'mr-0.5' : 'ml-0.5'}">${stars}</span></p>
                                <span class="text-xs text-gray-400">${date}</span>
                            </div>
                            <p class="text-xs text-gray-600">${comment}</p>
                        `;
                        ratingsListDiv.appendChild(ratingDiv);
                    });
                    ratingsListDiv.innerHTML += '</div>'; 
                }, (error) => {
                    console.error("Error loading ratings in onSnapshot:", error);
                    let errorMsg = getTranslation("error_loading_ratings_text", lang);
                     if (error.code === 'failed-precondition' && error.message.toLowerCase().includes('index')) {
                        errorMsg = getTranslation("index_required_for_query_text", lang); 
                    }
                    ratingsListDiv.innerHTML = `<p class="text-red-600 text-xs p-1 ${isSwal ? '' : 'bg-red-50 rounded-md'}">${errorMsg}</p>`;
                });
            } catch (error) {
                 console.error("Error setting up ratings query:", error);
                 ratingsListDiv.innerHTML = `<p class="text-red-600 text-xs p-1 ${isSwal ? '' : 'bg-red-50 rounded-md'}">${getTranslation("error_loading_ratings_text", lang)}</p>`;
            }
        }

        // Submit a new rating
        window.submitRating = async (establishmentId, isSwal = false) => {
            const lang = getCurrentLanguage();
            const feedbackIdSuffix = isSwal ? `swal-submit-rating-feedback-${establishmentId}` : `submit-rating-feedback-${establishmentId}`;
            const satisfactionIdSuffix = isSwal ? `swal-rating-satisfaction-${establishmentId}` : `rating-satisfaction-${establishmentId}`;
            const commentIdSuffix = isSwal ? `swal-rating-comment-${establishmentId}` : `rating-comment-${establishmentId}`;

            const feedbackDiv = document.getElementById(feedbackIdSuffix);
            if (!feedbackDiv) return; 
            feedbackDiv.textContent = ''; 

            if (!initialAuthCheckCompleted || !db || !auth.currentUser) { 
                 feedbackDiv.textContent = getTranslation("login_to_rate_text", lang);
                 feedbackDiv.className = 'text-red-600 text-xs mt-1';
                 return;
            }
            
            const satisfactionLevelEl = document.getElementById(satisfactionIdSuffix);
            const commentEl = document.getElementById(commentIdSuffix);

            if (!satisfactionLevelEl || !commentEl) return; 

            const satisfactionLevel = satisfactionLevelEl.value;
            const comment = commentEl.value.trim();

            if (!satisfactionLevel) {
                feedbackDiv.textContent = getTranslation("select_satisfaction_level_text", lang);
                feedbackDiv.className = 'text-red-600 text-xs mt-1';
                return;
            }

            feedbackDiv.textContent = getTranslation("submitting_rating_text", lang);
            feedbackDiv.className = 'text-indigo-600 text-xs mt-1';

            try {
                const ratingsPath = `artifacts/${appId}/public/data/ratings`;
                await addDoc(collection(db, ratingsPath), {
                    establishmentId: establishmentId,
                    userId: auth.currentUser.uid, 
                    visitorName: auth.currentUser.displayName || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : '') || getTranslation("visitor_text", lang), 
                    satisfactionLevel: parseInt(satisfactionLevel),
                    comment: comment,
                    createdAt: serverTimestamp() 
                });

                const establishmentRef = doc(db, `artifacts/${appId}/public/data/establishments`, establishmentId);
                const establishmentDoc = await getDoc(establishmentRef);

                if (establishmentDoc.exists()) {
                    const data = establishmentDoc.data();
                    const currentTotalRatingPoints = (data.averageRating || 0) * (data.ratingCount || 0);
                    const newRatingCount = (data.ratingCount || 0) + 1;
                    const newAverageRating = (currentTotalRatingPoints + parseInt(satisfactionLevel)) / newRatingCount;

                    await updateDoc(establishmentRef, {
                        averageRating: newAverageRating,
                        ratingCount: newRatingCount
                    });
                }

                feedbackDiv.textContent = getTranslation("rating_submitted_successfully_text", lang);
                feedbackDiv.className = 'text-green-600 text-xs mt-1';
                commentEl.value = ''; 
                if (isSwal) loadRatingsForEstablishment(establishmentId, true); 

            } catch (error) {
                console.error("Error submitting rating:", error);
                feedbackDiv.textContent = `${getTranslation("error_submitting_rating_text", lang)} ${error.message}`;
                feedbackDiv.className = 'text-red-600 text-xs mt-1';
            }
        };

        // Load paid/featured ads
        async function loadPaidAds() {
            const lang = getCurrentLanguage();
            if (!initialAuthCheckCompleted || !db || !paidAdsBanner) return; 
            paidAdsBanner.innerHTML = ''; 

            try {
                const publicEstablishmentsPath = `artifacts/${appId}/public/data/establishments`;
                const q = query(collection(db, publicEstablishmentsPath), where("isPaidAd", "==", true), where("status", "==", "approved"), orderBy("publishedAt", "desc"), limit(5));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    paidAdsBanner.classList.add('hidden'); 
                    return;
                }

                paidAdsBanner.classList.remove('hidden'); 
                let adItemsHtml = '';
                querySnapshot.forEach((docSnap) => {
                    const ad = docSnap.data();
                    const adName = getTranslatedFieldValue(ad.name, lang) || getTranslation("establishment_name_not_available", lang);
                    const adImage = ad.photos && ad.photos.length > 0 && ad.photos[0].startsWith('data:image')
                                  ? ad.photos[0]
                                  : `https://placehold.co/150x150/FFD700/4A5568?text=${encodeURIComponent(adName.charAt(0))}&font=cairo`; 

                    adItemsHtml += `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer" data-establishment-id="${docSnap.id}">
                            <img src="${adImage}" alt="${adName}" class="w-full h-32 sm:h-40 object-cover">
                            <div class="p-3 text-center">
                                <h4 class="font-semibold text-sm sm:text-base text-yellow-700 group-hover:text-yellow-600 truncate" title="${adName}">${adName}</h4>
                            </div>
                        </div>`;
                });
                 paidAdsBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-amber-400 via-yellow-400 to-orange-400 p-4 sm:p-6 rounded-xl shadow-xl text-white group mb-6">
                        <h3 class="font-extrabold text-xl sm:text-2xl mb-4 flex items-center justify-center sm:justify-start">
                            <i class="fas fa-star-and-crescent ${lang === 'ar' ? 'ml-3' : 'mr-3'} text-2xl sm:text-3xl text-white animate-pulse"></i>
                            <span data-translate-key="paid_ads_banner_title">${getTranslation("paid_ads_banner_title", lang)}</span>
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4">
                            ${adItemsHtml}
                        </div>
                    </div>`;

                paidAdsBanner.querySelectorAll('div[data-establishment-id]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const estId = e.currentTarget.dataset.establishmentId;
                        if(estId) window.showEstablishmentDetails(estId);
                    });
                });


            } catch (error) {
                console.error("Error fetching paid ads: ", error);
                paidAdsBanner.innerHTML = `<p class="text-red-600 text-center p-3 bg-red-50 rounded">${getTranslation("error_loading_paid_ads", lang)}</p>`;
                paidAdsBanner.classList.remove('hidden'); 
            }
        }

        // Show/hide loading indicator
        function showLoading(isLoading) {
            if (loadingIndicator) {
                loadingIndicator.style.display = isLoading ? 'flex' : 'none';
            }
        }

        // --- SweetAlert based Auth Modals ---
        function showLoginModal() {
            const lang = getCurrentLanguage();
            Swal.fire({
                title: `<div class="flex items-center justify-center text-indigo-600"><i class="fas fa-sign-in-alt text-3xl ${lang === 'ar' ? 'ml-3' : 'mr-3'}"></i><strong class="text-2xl">${getTranslation("login_modal_title", lang)}</strong></div>`,
                html: `
                    <div class="text-${lang === 'ar' ? 'right' : 'left'} space-y-5 p-2">
                        <div>
                            <label for="swal-login-email" class="label-text mb-1 text-gray-700">${getTranslation("email_label", lang)}</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 ${lang === 'ar' ? 'right-0 pr-3' : 'left-0 pl-3'} flex items-center pointer-events-none">
                                    <i class="fas fa-envelope text-gray-400"></i>
                                </div>
                                <input type="email" id="swal-login-email" required placeholder="${getTranslation("email_placeholder", lang)}" class="input-field w-full ${lang === 'ar' ? 'pr-10' : 'pl-10'}">
                            </div>
                        </div>
                        <div>
                            <label for="swal-login-password" class="label-text mb-1 text-gray-700">${getTranslation("password_label", lang)}</label>
                             <div class="relative">
                                <div class="absolute inset-y-0 ${lang === 'ar' ? 'right-0 pr-3' : 'left-0 pl-3'} flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input type="password" id="swal-login-password" required placeholder="${getTranslation("password_placeholder", lang)}" class="input-field w-full ${lang === 'ar' ? 'pr-10' : 'pl-10'}">
                            </div>
                        </div>
                        <div id="swal-login-feedback" class="feedback-error text-xs min-h-[18px] text-center"></div>
                    </div>
                `,
                confirmButtonText: getTranslation("login_btn_modal", lang),
                confirmButtonColor: '#10B981', 
                showCancelButton: true,
                cancelButtonText: getTranslation("cancel_btn", lang),
                focusConfirm: false,
                showLoaderOnConfirm: true,
                customClass: {
                    popup: 'rounded-xl shadow-2xl',
                    title: 'pt-5', 
                    htmlContainer: 'pt-0 pb-2',
                    actions: 'w-full flex justify-between px-4 pb-4 gap-3', 
                    confirmButton: 'btn-primary bg-green-500 hover:bg-green-600 focus:ring-green-500 flex-1', 
                    cancelButton: 'btn-secondary flex-1' 
                },
                footer: `<a href="#" id="swal-switch-to-register" class="text-indigo-600 hover:underline text-sm font-medium">${getTranslation("no_account_switch_to_register", lang)}</a>`,
                didOpen: () => {
                    document.getElementById('swal-switch-to-register')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        Swal.close();
                        showRegisterModal();
                    });
                },
                preConfirm: async () => {
                    const email = Swal.getPopup().querySelector('#swal-login-email').value;
                    const password = Swal.getPopup().querySelector('#swal-login-password').value;
                    const feedbackDiv = Swal.getPopup().querySelector('#swal-login-feedback');
                    feedbackDiv.textContent = ''; 

                    if (!email || !password) {
                        Swal.showValidationMessage(getTranslation("fill_all_fields_validation", lang));
                        return false; 
                    }
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        return true; 
                    } catch (error) {
                        console.error("Swal Login error:", error);
                        let errorMessage = getTranslation("login_fail_message_generic", lang);
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            errorMessage = getTranslation("login_fail_message_specific", lang);
                        }
                        Swal.showValidationMessage(errorMessage); 
                        feedbackDiv.textContent = errorMessage; 
                        return false; 
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({icon: 'success', title: getTranslation("login_success_title", lang), text: getTranslation("login_success_text", lang), timer: 1500, showConfirmButton: false});
                }
            });
        }

        function showRegisterModal() {
            const lang = getCurrentLanguage();
            Swal.fire({
                title: `<strong class="text-2xl text-indigo-600">${getTranslation("register_modal_title", lang)}</strong>`,
                html: `
                    <div class="text-${lang === 'ar' ? 'right' : 'left'} space-y-3 p-1">
                        <div>
                            <label for="swal-register-name" class="label-text mb-1">${getTranslation("full_name_label", lang)}</label>
                            <input type="text" id="swal-register-name" required class="input-field w-full">
                        </div>
                        <div>
                            <label for="swal-register-email" class="label-text mb-1">${getTranslation("email_label", lang)}</label>
                            <input type="email" id="swal-register-email" required placeholder="${getTranslation("email_placeholder", lang)}" class="input-field w-full">
                        </div>
                        <div>
                            <label for="swal-register-password" class="label-text mb-1">${getTranslation("password_min_chars_label", lang)}</label>
                            <input type="password" id="swal-register-password" required minlength="6" class="input-field w-full">
                        </div>
                        <div>
                            <label class="label-text mb-1">${getTranslation("account_type_label", lang)}</label>
                            <div class="mt-1.5 space-y-1 sm:space-y-0 sm:flex sm:space-x-4 ${lang === 'ar' ? 'sm:space-x-reverse' : ''}"> <div class="flex items-center">
                                    <input id="swal-role-investor" name="swal-account-type" type="radio" value="investor" required class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <label for="swal-role-investor" class="${lang === 'ar' ? 'mr-2' : 'ml-2'} block text-sm text-gray-700">${getTranslation("role_investor_label", lang)}</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="swal-role-visitor" name="swal-account-type" type="radio" value="visitor" required class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <label for="swal-role-visitor" class="${lang === 'ar' ? 'mr-2' : 'ml-2'} block text-sm text-gray-700">${getTranslation("role_visitor_label", lang)}</label>
                                </div>
                            </div>
                            <div id="swal-role-feedback" class="feedback-error text-xs min-h-[18px] mt-1"></div> </div>
                        <div id="swal-register-feedback" class="feedback-error text-xs min-h-[18px]"></div> </div>
                `,
                confirmButtonText: `<i class="fas fa-user-plus ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("create_account_btn", lang)}`,
                showCancelButton: true,
                cancelButtonText: getTranslation("cancel_btn", lang),
                focusConfirm: false,
                showLoaderOnConfirm: true,
                 customClass: { 
                    popup: 'rounded-xl',
                    actions: 'w-full flex justify-between', 
                    confirmButton: 'btn-primary', 
                    cancelButton: 'btn-secondary' 
                },
                footer: `<a href="#" id="swal-switch-to-login" class="text-indigo-600 hover:underline text-sm">${getTranslation("already_have_account_switch_to_login", lang)}</a>`,
                didOpen: () => {
                    document.getElementById('swal-switch-to-login')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        Swal.close();
                        showLoginModal();
                    });
                },
                preConfirm: async () => {
                    const name = Swal.getPopup().querySelector('#swal-register-name').value;
                    const email = Swal.getPopup().querySelector('#swal-register-email').value;
                    const password = Swal.getPopup().querySelector('#swal-register-password').value;
                    const selectedRoleInput = Swal.getPopup().querySelector('input[name="swal-account-type"]:checked');
                    const feedbackDiv = Swal.getPopup().querySelector('#swal-register-feedback');
                    const roleFeedbackDiv = Swal.getPopup().querySelector('#swal-role-feedback'); 
                    feedbackDiv.textContent = ''; 
                    roleFeedbackDiv.textContent = ''; 

                    if (!name || !email || !password) {
                        Swal.showValidationMessage(getTranslation("fill_all_fields_validation", lang));
                        return false;
                    }
                     if (!selectedRoleInput) {
                        roleFeedbackDiv.textContent = getTranslation("select_account_type_validation", lang); 
                        Swal.showValidationMessage(getTranslation("select_account_type_validation", lang)); 
                        return false;
                    }
                    const role = selectedRoleInput.value;

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile`, 'info');
                        await setDoc(userDocRef, {
                            name: name,
                            email: email,
                            role: role, 
                            createdAt: serverTimestamp()
                        });
                        return true;
                    } catch (error) {
                        console.error("Swal Registration error:", error);
                        let errorMessage = getTranslation("registration_fail_generic", lang);
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = getTranslation("registration_fail_email_in_use", lang);
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = getTranslation("registration_fail_weak_password", lang);
                        }
                        Swal.showValidationMessage(errorMessage);
                        feedbackDiv.textContent = errorMessage;
                        return false;
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(getTranslation("registration_success_title", lang), getTranslation("registration_success_text", lang), 'success');
                }
            });
        }

        // Show modal for adding a new establishment
        function showAddEstablishmentModal(savedData = window.tempEstablishmentData || {}) {
            const lang = getCurrentLanguage();
            let categoryOptionsHtml = categoryKeys.slice(1).map(catKey => `<option value="${catKey}" ${savedData.categoryKey === catKey ? 'selected' : ''}>${getTranslation(catKey, lang)}</option>`).join('');
            let governorateOptionsHtml = governorateKeys.slice(1).map(govKey => `<option value="${govKey}" ${savedData.governorateKey === govKey ? 'selected' : ''}>${getTranslation(govKey, lang)}</option>`).join('');

            let currentCoordsDisplay = "";
            const coordsToUse = savedData.coordinates || window.selectedCoordsForNewEstablishment; 
            if (coordsToUse) { 
                currentCoordsDisplay = `${coordsToUse.lat.toFixed(5)}, ${coordsToUse.lng.toFixed(5)}`;
            }
            
            let nameInputsHTML = '', descriptionInputsHTML = '', locationInputsHTML = '', priceInputsHTML = '';
            supportedLanguages.forEach(lObj => {
                nameInputsHTML += `
                    <div class="mt-1">
                        <label for="swal-establishment-name-${lObj.code}" class="text-xs text-gray-500">${lObj.name}</label>
                        <input type="text" id="swal-establishment-name-${lObj.code}" placeholder="${getTranslation(`establishment_name_placeholder_${lObj.code}`, lang)}" class="input-field w-full text-sm p-2" value="${savedData.name?.[lObj.code] || ''}">
                    </div>`;
                descriptionInputsHTML += `
                    <div class="mt-1">
                        <label for="swal-establishment-description-${lObj.code}" class="text-xs text-gray-500">${lObj.name}</label>
                        <textarea id="swal-establishment-description-${lObj.code}" rows="2" placeholder="${getTranslation(`description_placeholder_${lObj.code}`, lang)}" class="input-field w-full text-sm p-2">${savedData.description?.[lObj.code] || ''}</textarea>
                    </div>`;
                locationInputsHTML += `
                    <div class="mt-1">
                         <label for="swal-establishment-location-${lObj.code}" class="text-xs text-gray-500">${lObj.name}</label>
                        <input type="text" id="swal-establishment-location-${lObj.code}" placeholder="${getTranslation(`location_text_placeholder_${lObj.code}`, lang)}" class="input-field w-full text-sm p-2" value="${savedData.location?.[lObj.code] || ''}">
                    </div>`;
                priceInputsHTML += `
                    <div class="mt-1">
                        <label for="swal-establishment-price-${lObj.code}" class="text-xs text-gray-500">${lObj.name}</label>
                        <input type="text" id="swal-establishment-price-${lObj.code}" placeholder="${getTranslation(`price_range_placeholder_${lObj.code}`, lang)}" class="input-field w-full text-sm p-2" value="${savedData.priceRange?.[lObj.code] || ''}">
                    </div>`;
            });


            Swal.fire({
                title: `<strong class="text-2xl text-indigo-600">${getTranslation("add_establishment_modal_title", lang)}</strong>`,
                html: `
                    <form id="swal-add-establishment-form" class="text-${lang === 'ar' ? 'right' : 'left'} space-y-4 p-1">
                        <div>
                            <label class="label-text mb-1">${getTranslation("establishment_name_label", lang)}</label>
                            ${nameInputsHTML}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <label for="swal-establishment-category" class="label-text mb-1">${getTranslation("category_label_add_modal", lang)}</label>
                                <select id="swal-establishment-category" required class="input-field w-full">
                                    <option value="" disabled ${!savedData.categoryKey ? 'selected' : ''}>${getTranslation("select_category_option", lang)}</option>
                                    ${categoryOptionsHtml}
                                </select>
                            </div>
                            <div>
                                <label for="swal-establishment-governorate" class="label-text mb-1">${getTranslation("governorate_label_add_modal", lang)}</label>
                                <select id="swal-establishment-governorate" required class="input-field w-full">
                                    <option value="" disabled ${!savedData.governorateKey ? 'selected' : ''}>${getTranslation("select_governorate_option", lang)}</option>
                                    ${governorateOptionsHtml}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="label-text mb-1">${getTranslation("description_label", lang)}</label>
                            ${descriptionInputsHTML}
                        </div>
                        <div>
                            <label class="label-text mb-1">${getTranslation("location_text_label", lang)}</label>
                            ${locationInputsHTML}
                        </div>
                         <div>
                            <label class="label-text mb-1">${getTranslation("price_range_label", lang)}</label>
                            ${priceInputsHTML}
                        </div>
                        <div>
                             <button type="button" id="swal-select-location-btn" class="btn-secondary text-sm py-2 w-full mb-2"><i class="fas fa-map-marker-alt ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("select_location_on_map_btn", lang)}</button>
                             <input type="text" id="swal-establishment-coordinates-display" readonly placeholder="${getTranslation("coordinates_placeholder", lang)}" class="input-field w-full bg-gray-100 text-sm cursor-not-allowed" value="${currentCoordsDisplay}">
                        </div>
                        <div>
                            <label for="swal-establishment-photos" class="label-text mb-1">${getTranslation("photos_label", lang)}</label>
                            <input type="file" id="swal-establishment-photos" multiple accept="image/jpeg, image/png, image/gif" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border file:border-gray-300 file:text-sm file:font-medium file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                             <div id="swal-photo-preview-container" class="mt-2 grid grid-cols-3 gap-2"></div>
                        </div>
                        <div id="swal-add-establishment-feedback" class="feedback-error text-xs min-h-[18px]"></div>
                    </form>
                `,
                confirmButtonText: `<i class="fas fa-plus-circle ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("add_establishment_submit_btn", lang)}`,
                showCancelButton: true,
                cancelButtonText: getTranslation("cancel_btn", lang),
                focusConfirm: false,
                showLoaderOnConfirm: true,
                width: '90%', 
                maxWidth: '700px', 
                customClass: {
                    popup: 'rounded-xl',
                    actions: 'w-full flex justify-between mt-4', 
                    confirmButton: 'btn-primary bg-amber-500 hover:bg-amber-600 focus:ring-amber-500', 
                    cancelButton: 'btn-secondary' 
                },
                didOpen: () => {
                    const photosInput = Swal.getPopup().querySelector('#swal-establishment-photos');
                    const previewContainer = Swal.getPopup().querySelector('#swal-photo-preview-container');
                    if (photosInput && previewContainer) {
                        photosInput.addEventListener('change', function(event) {
                            previewContainer.innerHTML = ''; 
                            if (this.files) {
                                Array.from(this.files).slice(0, 5).forEach(file => { 
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        const img = document.createElement('img');
                                        img.src = e.target.result;
                                        img.className = 'w-full h-20 object-cover rounded-md';
                                        previewContainer.appendChild(img);
                                    }
                                    reader.readAsDataURL(file);
                                });
                            }
                        });
                    }

                    const selectLocationBtn = Swal.getPopup().querySelector('#swal-select-location-btn');
                    if (selectLocationBtn) {
                        selectLocationBtn.addEventListener('click', () => {
                            const currentForm = Swal.getPopup().querySelector('#swal-add-establishment-form');
                            window.tempEstablishmentData.name = {}; 
                            window.tempEstablishmentData.description = {};
                            window.tempEstablishmentData.location = {};
                            window.tempEstablishmentData.priceRange = {};

                            supportedLanguages.forEach(lObj => {
                                window.tempEstablishmentData.name[lObj.code] = currentForm.querySelector(`#swal-establishment-name-${lObj.code}`).value;
                                window.tempEstablishmentData.description[lObj.code] = currentForm.querySelector(`#swal-establishment-description-${lObj.code}`).value;
                                window.tempEstablishmentData.location[lObj.code] = currentForm.querySelector(`#swal-establishment-location-${lObj.code}`).value;
                                window.tempEstablishmentData.priceRange[lObj.code] = currentForm.querySelector(`#swal-establishment-price-${lObj.code}`).value;
                            });
                            
                            window.tempEstablishmentData.categoryKey = currentForm.querySelector('#swal-establishment-category').value;
                            window.tempEstablishmentData.governorateKey = currentForm.querySelector('#swal-establishment-governorate').value;
                            window.tempEstablishmentData.coordinates = window.selectedCoordsForNewEstablishment; 

                            Swal.close(); 
                            setTimeout(() => { 
                                openLocationPickerForEstablishment();
                            }, 150); 
                        });
                    }
                },
                preConfirm: async () => {
                    const form = Swal.getPopup().querySelector('#swal-add-establishment-form');
                    const feedbackDiv = Swal.getPopup().querySelector('#swal-add-establishment-feedback');
                    feedbackDiv.textContent = ''; 

                    if (!auth.currentUser || userRole !== 'investor') {
                        Swal.showValidationMessage(getTranslation("add_establishment_validation_error_auth", lang));
                        return false;
                    }

                    const establishmentName = {};
                    const establishmentDescription = {};
                    const establishmentLocation = {}; 
                    const establishmentPriceRange = {}; 
                    let hasAtLeastOneName = false;

                    supportedLanguages.forEach(lObj => {
                        const nameVal = form.querySelector(`#swal-establishment-name-${lObj.code}`).value.trim();
                        if (nameVal) {
                            establishmentName[lObj.code] = nameVal;
                            if (lObj.code === 'ar' || !hasAtLeastOneName) hasAtLeastOneName = true; 
                        }
                        establishmentDescription[lObj.code] = form.querySelector(`#swal-establishment-description-${lObj.code}`).value.trim();
                        establishmentLocation[lObj.code] = form.querySelector(`#swal-establishment-location-${lObj.code}`).value.trim();
                        establishmentPriceRange[lObj.code] = form.querySelector(`#swal-establishment-price-${lObj.code}`).value.trim();
                    });


                    const categoryKey = form.querySelector('#swal-establishment-category').value; 
                    const governorateKey = form.querySelector('#swal-establishment-governorate').value; 
                    const photosInput = form.querySelector('#swal-establishment-photos');

                    if (!hasAtLeastOneName || !categoryKey || !governorateKey) { 
                        Swal.showValidationMessage(getTranslation("add_establishment_validation_error", lang));
                        return false;
                    }
                     if (!window.selectedCoordsForNewEstablishment) { 
                        Swal.showValidationMessage(getTranslation("select_location_validation_error", lang));
                        return false;
                    }

                    feedbackDiv.className = 'feedback-info text-xs'; 
                    feedbackDiv.textContent = getTranslation("adding_establishment_feedback", lang);

                    try {
                        let photoBase64Strings = [];
                        if (photosInput.files.length > 0) {
                            for (const file of Array.from(photosInput.files).slice(0, 5)) { 
                                const compressedBase64 = await new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        const img = new Image();
                                        img.onload = () => {
                                            const canvas = document.createElement('canvas');
                                            const MAX_WIDTH = 800; 
                                            const MAX_HEIGHT = 600; 
                                            let width = img.width;
                                            let height = img.height;

                                            if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                                            } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                                            canvas.width = width; canvas.height = height;
                                            const ctx = canvas.getContext('2d');
                                            ctx.drawImage(img, 0, 0, width, height);
                                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                                        };
                                        img.onerror = reject;
                                        img.src = event.target.result;
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(file);
                                });
                                photoBase64Strings.push(compressedBase64);
                            }
                        }

                        const establishmentDocData = {
                            ownerId: auth.currentUser.uid, ownerEmail: auth.currentUser.email,
                            name: establishmentName, 
                            description: establishmentDescription, 
                            location: establishmentLocation, 
                            priceRange: establishmentPriceRange, 
                            categoryKey: categoryKey, 
                            governorateKey: governorateKey, 
                            coordinates: new GeoPoint(window.selectedCoordsForNewEstablishment.lat, window.selectedCoordsForNewEstablishment.lng),
                            photos: photoBase64Strings, 
                            averageRating: 0, ratingCount: 0, isPaidAd: false,
                            paidAdRequestStatus: "none", 
                            publishedAt: serverTimestamp(), status: "pending" 
                        };
                        
                        const publicEstablishmentsPath = `artifacts/${appId}/public/data/establishments`;
                        await addDoc(collection(db, publicEstablishmentsPath), establishmentDocData);
                        window.selectedCoordsForNewEstablishment = null; 
                        window.tempEstablishmentData = {}; 
                        return true; 
                    } catch (error) {
                        console.error("Swal Add Establishment error:", error);
                        const errMsg = `${getTranslation("add_establishment_error_feedback", lang)} ${error.message}`;
                        Swal.showValidationMessage(errMsg);
                        feedbackDiv.className = 'feedback-error text-xs';
                        feedbackDiv.textContent = errMsg;
                        return false; 
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(getTranslation("registration_success_title", lang), getTranslation("add_establishment_success_text", lang), 'success');
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    console.log("Add establishment Swal cancelled. Restoring with temp data if available.");
                    const dataToRestoreOnCancel = { ...window.tempEstablishmentData }; 
                    if (window.selectedCoordsForNewEstablishment) {
                        dataToRestoreOnCancel.coordinates = window.selectedCoordsForNewEstablishment;
                    }
                     if (Object.values(dataToRestoreOnCancel.name || {}).some(v => v) || 
                        Object.values(dataToRestoreOnCancel.description || {}).some(v => v) ||
                        Object.values(dataToRestoreOnCancel.location || {}).some(v => v) ||
                        dataToRestoreOnCancel.categoryKey || dataToRestoreOnCancel.governorateKey ||
                        dataToRestoreOnCancel.coordinates) {
                        showAddEstablishmentModal(dataToRestoreOnCancel);
                    }
                }
                 if (!result.isConfirmed && result.dismiss === Swal.DismissReason.cancel && !Object.values(window.tempEstablishmentData.name || {}).some(v => v) ) {
                    window.tempEstablishmentData = {};
                 }
            });
        }

        // Open location picker modal
        function openLocationPickerForEstablishment() {
            const lang = getCurrentLanguage();
            let tempMarker = null; 
            let pickerMapInstance = null; 
            let localSelectedCoords = window.selectedCoordsForNewEstablishment ? L.latLng(window.selectedCoordsForNewEstablishment.lat, window.selectedCoordsForNewEstablishment.lng) : null;

            Swal.fire({
                title: getTranslation("pick_location_modal_title", lang),
                html: `
                    <div id="location-picker-map-swal" style="height: 400px; width: 100%;"></div>
                    <button id="use-my-current-location-btn-picker" class="btn-secondary text-sm py-2 w-full mt-3 mb-2"><i class="fas fa-location-arrow ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("use_my_location_btn_picker", lang)}</button>
                    <p class="text-xs text-gray-500 mt-1">${getTranslation("click_map_to_select_location_note", lang)}</p>
                `,
                showCancelButton: true,
                confirmButtonText: `${getTranslation("confirm_location_btn", lang)} <i class="fas fa-check ${lang === 'ar' ? 'mr-2' : 'ml-2'}"></i>`,
                cancelButtonText: getTranslation("cancel_btn", lang),
                width: '90%',
                maxWidth: '600px',
                customClass: { popup: 'rounded-xl' },
                didOpen: () => {
                    const mapElement = Swal.getPopup().querySelector('#location-picker-map-swal');
                    const useMyLocBtn = Swal.getPopup().querySelector('#use-my-current-location-btn-picker');

                    if (mapElement) {
                        const initialView = localSelectedCoords ? [localSelectedCoords.lat, localSelectedCoords.lng] : [35.0, 38.0]; 
                        const initialZoom = localSelectedCoords ? 15 : 6;
                        pickerMapInstance = L.map(mapElement).setView(initialView, initialZoom);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMapInstance);

                        if(localSelectedCoords){
                             tempMarker = L.marker(localSelectedCoords).addTo(pickerMapInstance).bindPopup(getTranslation("map_marker_selected_location", lang)).openPopup();
                        }

                        pickerMapInstance.on('click', function(e) {
                            if (tempMarker) pickerMapInstance.removeLayer(tempMarker);
                            localSelectedCoords = e.latlng; 
                            tempMarker = L.marker(e.latlng).addTo(pickerMapInstance)
                                .bindPopup(getTranslation("map_marker_establishment_location", lang)).openPopup();
                            console.log("Map Picker: Location selected by click - ", localSelectedCoords);
                        });

                        if (useMyLocBtn && navigator.geolocation) {
                            useMyLocBtn.addEventListener('click', () => {
                                Swal.showLoading();
                                navigator.geolocation.getCurrentPosition(position => {
                                    Swal.close();
                                    const userLat = position.coords.latitude;
                                    const userLng = position.coords.longitude;
                                    if (tempMarker) pickerMapInstance.removeLayer(tempMarker);
                                    localSelectedCoords = L.latLng(userLat, userLng); 
                                    tempMarker = L.marker(localSelectedCoords).addTo(pickerMapInstance)
                                        .bindPopup(getTranslation("map_marker_current_location_selected", lang)).openPopup();
                                    pickerMapInstance.setView(localSelectedCoords, 15);
                                    console.log("Map Picker: User's current location selected - ", localSelectedCoords);
                                }, (error) => {
                                    Swal.close();
                                    console.warn("Map Picker: Error getting current location.", error);
                                    Swal.fire(getTranslation("establishment_details_error_title", lang), getTranslation("error_getting_current_location", lang), 'error');
                                });
                            });
                        } else if (!navigator.geolocation && useMyLocBtn) {
                             useMyLocBtn.disabled = true; 
                             useMyLocBtn.textContent = getTranslation("map_marker_geolocation_not_supported", lang);
                        }
                    } else {
                        console.error("Location picker map container not found in Swal.");
                    }
                },
                preConfirm: () => {
                    if (!localSelectedCoords) {
                        Swal.showValidationMessage(getTranslation("location_picker_validation_error", lang));
                        return false; 
                    }
                    return localSelectedCoords; 
                },
                willClose: () => { 
                    if (pickerMapInstance) {
                        pickerMapInstance.remove();
                        pickerMapInstance = null;
                    }
                }
            }).then((result) => {
                const dataToRestore = { ...window.tempEstablishmentData }; 
                if (result.isConfirmed && result.value) {
                    window.selectedCoordsForNewEstablishment = { lat: result.value.lat, lng: result.value.lng }; 
                    console.log("Map Picker: Confirmed coordinates", window.selectedCoordsForNewEstablishment);
                    dataToRestore.coordinates = window.selectedCoordsForNewEstablishment; 
                } else {
                    console.log("Map Picker: Cancelled. Re-opening add form with previous data.");
                    dataToRestore.coordinates = window.tempEstablishmentData.coordinates || null;
                }
                setTimeout(() => { 
                    showAddEstablishmentModal(dataToRestore);
                }, 150);
            });
        }


        // Request to make an establishment a paid ad
        async function requestPaidAd(establishmentId) {
            const lang = getCurrentLanguage();
            if (!auth.currentUser || !db) { 
                Swal.fire(getTranslation("establishment_details_error_title", lang), getTranslation("request_paid_ad_error_login", lang), 'error');
                return;
            }
            const establishmentRef = doc(db, `artifacts/${appId}/public/data/establishments`, establishmentId);
            try {
                await updateDoc(establishmentRef, {
                    paidAdRequestStatus: "pending" 
                });
                Swal.fire(getTranslation("request_paid_ad_success_title", lang), getTranslation("request_paid_ad_success_text", lang), 'success').then(() => {
                    if (Swal.isVisible()) Swal.close(); 
                    setTimeout(() => window.showEstablishmentDetails(establishmentId), 100); 
                });
            } catch (error) {
                console.error("Error requesting paid ad:", error);
                Swal.fire(getTranslation("establishment_details_error_title", lang), getTranslation("request_paid_ad_error_text", lang), 'error');
            }
        }

        // Function to check user's country and display VPN notification if in Syria
        async function checkUserCountryAndNotify() {
            const lang = getCurrentLanguage();
            try {
                // Using a free IP Geolocation API. Replace if you have a preferred or more robust service.
                // Note: Client-side IP geolocation can be spoofed and is not 100% reliable.
                const response = await fetch('http://ip-api.com/json');
                if (!response.ok) {
                    console.warn('IP Geolocation request failed:', response.status);
                    return;
                }
                const data = await response.json();
                console.log('User Geolocation Data:', data);

                if (data && data.countryCode === 'SY') {
                    Swal.fire({
                        title: getTranslation("syria_vpn_notice_title", lang),
                        html: `<p class="text-${lang === 'ar' ? 'right' : 'left'} text-sm text-gray-700">${getTranslation("syria_vpn_notice_text", lang)}</p>`,
                        icon: 'warning',
                        confirmButtonText: getTranslation("syria_vpn_notice_confirm_btn", lang),
                        customClass: { 
                            popup: 'rounded-xl',
                            confirmButton: 'btn-primary'
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }
            } catch (error) {
                console.error('Error during IP Geolocation check:', error);
            }
        }


        // Event listener for logout button
        const logoutButton = document.getElementById('logout-btn');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    console.log("Auth: User initiated logout.");
                    isAuthDataLoaded = false; 
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });
        }

        // DOMContentLoaded: Setup event listeners after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Setting up event listeners.");
            
            checkUserCountryAndNotify(); // Check user's country on load

            const langSelect = document.getElementById('lang-select');
            if (langSelect) {
                supportedLanguages.forEach(l => {
                    const option = document.createElement('option');
                    option.value = l.code;
                    option.textContent = l.name;
                    if (l.code === currentLanguage) {
                        option.selected = true;
                    }
                    langSelect.appendChild(option);
                });
                langSelect.addEventListener('change', (e) => {
                    setCurrentLanguage(e.target.value);
                });
            }
            
            applyTranslationsToUI(); 

            // Apply Filters button listener
            if (applyFiltersBtn) {
                 applyFiltersBtn.addEventListener('click', () => loadEstablishments());
            }
            // Also trigger loadEstablishments if Enter key is pressed in name search input
            if (nameSearchInput) {
                nameSearchInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        loadEstablishments();
                    }
                });
            }
            
            document.querySelectorAll('[data-close-modal]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const modalId = event.target.closest('.modal-container')?.id || button.dataset.closeModal;
                    if (modalId) {
                        console.log(`Closing modal: ${modalId} via [data-close-modal] button.`);
                        window.closeModal(modalId);
                    }
                });
            });

            const loginRegisterBtn = document.getElementById('login-register-btn');
            if (loginRegisterBtn) {
                loginRegisterBtn.addEventListener('click', () => {
                    console.log("Login/Register button clicked. Opening SweetAlert login.");
                    showLoginModal();
                });
            } else {
                console.error("Button with ID 'login-register-btn' not found in DOM.");
            }

            const addEstablishmentBtn = document.getElementById('open-add-establishment-modal-btn');
            if (addEstablishmentBtn) {
                addEstablishmentBtn.addEventListener('click', () => {
                    console.log("Add Establishment button clicked. Opening SweetAlert for add establishment.");
                    window.tempEstablishmentData = { name:{}, description:{}, location:{}, priceRange:{} }; 
                    window.selectedCoordsForNewEstablishment = null; 
                    showAddEstablishmentModal();
                });
            } else {
                 console.error("Button with ID 'open-add-establishment-modal-btn' not found in DOM.");
            }

            const managePaidAdsBtn = document.getElementById('open-manage-paid-ads-modal-btn');
            if (managePaidAdsBtn) {
                managePaidAdsBtn.addEventListener('click', () => {
                    console.log("Manage Paid Ads button clicked. Attempting to open 'manage-paid-ads-modal'.");
                    window.openModal('manage-paid-ads-modal'); 
                });
            } else {
                console.error("Button with ID 'open-manage-paid-ads-modal-btn' not found in DOM.");
            }

            const aboutUsLink = document.getElementById('about-us-link');
            if (aboutUsLink) {
                aboutUsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lang = getCurrentLanguage();
                    Swal.fire({
                        title: getTranslation("about_us_modal_title", lang),
                        html: `
                            <div class="prose prose-sm sm:prose-base text-${lang === 'ar' ? 'right' : 'left'} space-y-3 leading-relaxed p-2 text-gray-700">
                                <p>${getTranslation("about_us_modal_content1", lang)}</p>
                                <p>${getTranslation("about_us_modal_content2", lang)}</p>
                            </div>
                        `,
                        confirmButtonText: getTranslation("got_it_btn", lang),
                        customClass: { 
                            popup: 'rounded-xl',
                            htmlContainer: 'text-sm sm:text-base' 
                        }
                    });
                });
            } else {
                console.error("Link with ID 'about-us-link' not found in DOM.");
            }

            const complaintsLink = document.getElementById('complaints-suggestions-link');
            if (complaintsLink) {
                complaintsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lang = getCurrentLanguage();
                    const complaintEmail = "hackmack040@gmail.com";
                    Swal.fire({
                        title: getTranslation("complaints_suggestions_modal_title", lang),
                        html: `
                            <p class="mb-3 text-gray-700 text-sm">${getTranslation("complaints_email_text", lang)}</p>
                            <p class="font-semibold text-indigo-600 text-lg break-all mb-3">${complaintEmail}</p>
                        `,
                        confirmButtonText: `<i class="fas fa-copy ${lang === 'ar' ? 'ml-2' : 'mr-2'}"></i>${getTranslation("copy_email_btn", lang)}`,
                        showCancelButton: true,
                        cancelButtonText: getTranslation("cancel_btn", lang),
                        customClass: { popup: 'rounded-xl' },
                        preConfirm: () => {
                            const tempInput = document.createElement("input");
                            tempInput.style.position = "absolute";
                            tempInput.style.left = "-1000px";
                            tempInput.style.top = "-1000px";
                            tempInput.value = complaintEmail;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            try {
                                document.execCommand('copy');
                                Swal.showValidationMessage(getTranslation("email_copied_alert", lang)); 
                                setTimeout(() => Swal.resetValidationMessage(), 1500); 
                            } catch (err) {
                                console.error('Fallback: Oops, unable to copy', err);
                                Swal.showValidationMessage('Failed to copy email.'); 
                            }
                            document.body.removeChild(tempInput);
                            return false; 
                        }
                    });
                });
            } else {
                console.error("Link with ID 'complaints-suggestions-link' not found in DOM.");
            }


            const establishmentsContainerEl = document.getElementById('establishments-container');
            if (establishmentsContainerEl) {
                establishmentsContainerEl.addEventListener('click', (event) => {
                    const targetButton = event.target.closest('button.show-details-btn');
                    if (targetButton) {
                        const establishmentId = targetButton.dataset.establishmentId;
                        if (establishmentId) {
                            console.log(`Show details button clicked for establishment ID: ${establishmentId}`);
                            window.showEstablishmentDetails(establishmentId);
                        }
                    }
                });
            }
            const paidAdsBannerEl = document.getElementById('paid-ads-banner');
            if (paidAdsBannerEl) {
                paidAdsBannerEl.addEventListener('click', (event) => {
                     const targetDiv = event.target.closest('div[data-establishment-id]'); 
                    if (targetDiv) {
                        const establishmentId = targetDiv.dataset.establishmentId;
                         if (establishmentId) {
                            console.log(`Paid ad item clicked for establishment ID: ${establishmentId}`);
                            window.showEstablishmentDetails(establishmentId);
                        }
                    }
                });
            }
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('show-details-btn-map')) {
                    const establishmentId = event.target.dataset.id;
                    if (establishmentId) {
                         console.log(`Show details (from map popup) clicked for establishment ID: ${establishmentId}`);
                         window.showEstablishmentDetails(establishmentId);
                    }
                }
            });

            const myEstablishmentsBtn = document.getElementById('show-my-establishments-btn');
            if (myEstablishmentsBtn) {
                myEstablishmentsBtn.addEventListener('click', () => {
                    const lang = getCurrentLanguage();
                    if (userId && userRole === 'investor') {
                        console.log("Show My Establishments button clicked.");
                        document.getElementById('main-content-area-title').textContent = getTranslation("my_establishments_page_title", lang);
                        loadEstablishments(userId); 
                    } else if (userId && userRole !== 'investor') {
                         Swal.fire(getTranslation("establishment_details_error_title", lang), getTranslation("my_establishments_owner_only_alert", lang), 'info');
                    }
                    else { 
                         Swal.fire(getTranslation("establishment_details_error_title", lang), getTranslation("my_establishments_login_alert", lang), 'info');
                    }
                });
            }


            console.log("All DOMContentLoaded event listeners setup attempted.");
        });

    </script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f8fc; 
            color: #333; 
        }
        .modal-container {
             @apply fixed inset-0 z-[9990] bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 ease-in-out;
        }
        .modal-content {
            @apply bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-h-[90vh] overflow-y-auto;
        }
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #establishments-container > div { animation: fadeIn 0.5s ease-out forwards; }

        #sidebar { /* This is now the main filter section, not a sidebar */
            @apply w-full bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 transition-all duration-300;
        }
        #sidebar::-webkit-scrollbar { width: 5px; }
        #sidebar::-webkit-scrollbar-track { background: #f9fafb; }
        #sidebar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }


        .feedback-base { @apply text-sm mt-2 p-2.5 rounded-md border; }
        .feedback-info { @apply feedback-base bg-blue-50 border-blue-300 text-blue-700; }
        .feedback-success { @apply feedback-base bg-green-50 border-green-300 text-green-700; }
        .feedback-error { @apply feedback-base bg-red-50 border-red-300 text-red-700; }

        .swal2-input, .swal2-textarea, #swal-establishment-category, #swal-establishment-governorate {
             @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .swal2-html-container input[type="radio"] {
            @apply appearance-none border-2 border-gray-300 rounded-full w-4 h-4 mt-0.5 transition duration-200 ease-in-out align-middle;
        }
        .swal2-html-container input[type="radio"]:checked {
            @apply border-indigo-600 bg-indigo-600;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
        }
         .swal2-html-container input[type="radio"]:focus {
            @apply ring-2 ring-offset-1 ring-indigo-400; 
        }
         html[dir="rtl"] .swal2-html-container .label-text { text-align: right; }
         html[dir="ltr"] .swal2-html-container .label-text { text-align: left; }
         .swal2-html-container .label-text { @apply block text-sm font-semibold text-gray-700; }


        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 sm:px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transform active:scale-95 text-sm sm:text-base;
        }
        .btn-secondary {
             @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2.5 px-4 sm:px-6 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transform active:scale-95 text-sm sm:text-base;
        }
        .input-field {
            @apply mt-1 block w-full px-3 sm:px-4 py-2 sm:py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm sm:text-base transition-shadow duration-200;
        }
        .input-field:focus { @apply shadow-md; } 
        
        html[dir="rtl"] .label-text { text-align: right; }
        html[dir="ltr"] .label-text { text-align: left; }
        .label-text {
            @apply block text-sm font-semibold text-gray-700;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px; 
        }
        .leaflet-popup-content {
            font-family: 'Cairo', sans-serif; 
        }
        .leaflet-popup-content .show-details-btn-map { 
            color: #4f46e5; 
            text-decoration: underline;
            font-size: 0.75rem; 
            margin-top: 4px;
            display: inline-block;
        }
        .leaflet-popup-content .show-details-btn-map:hover {
            color: #3730a3; 
        }
        html[dir="rtl"] .swal2-html-container { text-align: right !important; }
        html[dir="ltr"] .swal2-html-container { text-align: left !important; }

        #location-picker-map-swal {
            height: 350px; 
            width: 100%;
            margin-top: 10px;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
        }
        html[dir="rtl"] .fas[class*="mr-"], html[dir="rtl"] .fa[class*="mr-"] { margin-right: 0 !important; margin-left: 0.5rem !important; }
        html[dir="ltr"] .fas[class*="ml-"], html[dir="ltr"] .fa[class*="ml-"] { margin-left: 0 !important; margin-right: 0.5rem !important; }

        html[dir="rtl"] .swal2-html-container .relative .absolute.inset-y-0.right-0 { right: auto; left: 0; padding-right:0; padding-left: 0.75rem; }
        html[dir="rtl"] .swal2-html-container .relative input.pr-10 { padding-right: 0.75rem; padding-left: 2.5rem; }
        
        html[dir="rtl"] .swal2-html-container input[type="radio"] + label { margin-right: 0.5rem; margin-left: 0;}
        html[dir="ltr"] .swal2-html-container input[type="radio"] + label { margin-left: 0.5rem; margin-right: 0;}

        /* Header adjustments for mobile */
        @media (max-width: 640px) { /* sm breakpoint */
            header .container > div { /* Target the flex container for buttons */
                flex-direction: column;
                align-items: stretch; /* Make buttons full width */
                width: 100%;
            }
            header .container > div > * { /* Target direct children of the button container */
                margin-top: 0.5rem; /* Add some space between stacked items */
                width: 100%; /* Make buttons take full width */
            }
             header .container > div > *:first-child {
                margin-top: 0;
            }
            #user-auth-status {
                text-align: center;
            }
            #language-switcher select {
                width: 100%;
                text-align: center;
            }
        }

    </style>
</head>
<body class="bg-slate-100"> <header class="bg-white text-gray-800 shadow-lg sticky top-0 z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4 flex flex-wrap justify-between items-center">
            <a href="#" id="logo-link" class="text-2xl sm:text-3xl font-extrabold text-indigo-600 hover:text-indigo-700 transition-colors">
                <i class="fas fa-map-signs"></i><span data-translate-key="logo_text" class="mr-2 ml-2">دليلك</span>
            </a>
            <!-- Auth and Action Buttons Wrapper -->
            <div class="flex flex-wrap items-center gap-2 mt-3 sm:mt-0 w-full sm:w-auto justify-center sm:justify-end">
                <div id="language-switcher" class="ml-2 mr-2"> 
                    <select id="lang-select" class="input-field text-xs sm:text-sm py-1 px-2 bg-gray-50 border-gray-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </select>
                </div>
                <span id="user-auth-status" class="text-xs sm:text-sm text-gray-600 px-2 py-1 sm:px-3 sm:py-1.5 bg-gray-100 rounded-lg shadow-inner order-first sm:order-none" data-translate-key="user_auth_status_visitor">أنت تتصفح كـ <span class="font-semibold">زائر</span> <i class="fas fa-user-secret text-gray-400"></i></span>
                <button id="login-register-btn" class="btn-primary text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2.5"><i class="fas fa-sign-in-alt"></i> <span data-translate-content="true" data-translate-key="login_register_btn">تسجيل/إنشاء حساب</span></button>
                <div id="add-establishment-btn-container" class="hidden"> 
                    <button id="open-add-establishment-modal-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1.5 px-3 sm:py-2.5 sm:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs sm:text-sm"><i class="fas fa-plus-circle"></i> <span data-translate-content="true" data-translate-key="add_establishment_btn">أضف منشأتك</span></button>
                </div>
                <div id="my-establishments-btn-container" class="hidden"> 
                    <button id="show-my-establishments-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-1.5 px-3 sm:py-2.5 sm:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs sm:text-sm"><i class="fas fa-store"></i> <span data-translate-content="true" data-translate-key="my_establishments_btn">منشآتي</span></button>
                </div>
                <div id="manage-paid-ads-btn-container" class="hidden"> 
                    <button id="open-manage-paid-ads-modal-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1.5 px-3 sm:py-2.5 sm:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs sm:text-sm"><i class="fas fa-ad"></i> <span data-translate-content="true" data-translate-key="manage_paid_ads_btn">إدارة الإعلانات</span></button>
                </div>
                <button id="logout-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 sm:py-2.5 sm:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs sm:text-sm"><i class="fas fa-sign-out-alt"></i> <span data-translate-content="true" data-translate-key="logout_btn">تسجيل الخروج</span></button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Paid Ads Banner Section -->
        <div id="paid-ads-banner" class="hidden">
            <!-- Content will be loaded by JS -->
        </div>

        <!-- Filters Section (Moved Here) -->
        <aside id="sidebar" class="w-full bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 transition-all duration-300">
            <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-5 border-b-2 border-gray-200 pb-3">
                <i class="fas fa-filter text-indigo-500"></i> <span data-translate-key="filter_search_title" class="mr-2 ml-2">فلترة البحث</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="name-search-input" class="label-text mb-1.5" data-translate-key="search_by_name_label">البحث بالاسم:</label>
                    <input type="text" id="name-search-input" data-translate-placeholder="search_by_name_placeholder" placeholder="أدخل اسم المنشأة..." class="input-field w-full">
                </div>
                <div>
                    <label for="category-filter" class="label-text mb-1.5" data-translate-key="category_filter_label">التصنيف:</label>
                    <select id="category-filter" class="input-field w-full">
                    </select>
                </div>
                <div>
                    <label for="governorate-filter" class="label-text mb-1.5" data-translate-key="governorate_filter_label">المحافظة:</label>
                    <select id="governorate-filter" class="input-field w-full">
                    </select>
                </div>
                <div class="sm:col-span-2 lg:col-span-1 lg:mt-0"> <!-- Button spans full on small, adjusts on larger -->
                     <button id="apply-filters-btn" class="btn-primary w-full mt-4 sm:mt-0"><i class="fas fa-search mr-2 ml-2"></i><span data-translate-key="apply_filters_btn">تطبيق الفلاتر</span></button>
                </div>
            </div>
             <hr class="my-6 sm:my-8 border-gray-200"> 
             <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b-2 border-gray-200 pb-2 sm:pb-3">
                <i class="fas fa-link text-indigo-500"></i> <span data-translate-key="useful_links_title" class="mr-2 ml-2">روابط مفيدة</span>
            </h2>
            <nav class="space-y-1.5 sm:space-y-2">
                <a href="#" id="complaints-suggestions-link" class="flex items-center text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg p-2 sm:p-2.5 transition-all duration-200 font-medium text-sm sm:text-base">
                    <i class="fas fa-envelope-open-text w-5 text-center"></i><span data-translate-key="complaints_suggestions_link" class="mr-3 ml-3">شكاوى واقتراحات</span>
                </a>
                <a href="#" id="about-us-link" class="flex items-center text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg p-2 sm:p-2.5 transition-all duration-200 font-medium text-sm sm:text-base">
                    <i class="fas fa-info-circle w-5 text-center"></i><span data-translate-key="about_us_link" class="mr-3 ml-3">من نحن</span>
                </a>
            </nav>
        </aside>

        <!-- Main content: Establishments Grid and Map -->
        <main id="main-content-area" class="w-full"> 
            <h2 id="main-content-area-title" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6" data-translate-key="latest_establishments_title">أحدث المنشآت المضافة</h2>
            <div id="loading-indicator" class="hidden justify-center items-center py-12 flex-col">
                <svg class="animate-spin h-12 w-12 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-600" data-translate-key="loading_establishments_text">جاري تحميل المنشآت...</p>
            </div>
            <div id="no-results-message" class="text-center py-12 text-gray-500 hidden">
                <i class="fas fa-search-minus fa-3x text-gray-400 mb-4"></i>
                <h3 class="mt-2 text-xl font-semibold text-gray-800" data-translate-key="no_results_title">لا توجد نتائج</h3>
                <p class="mt-1 text-base text-gray-500" data-translate-key="no_results_message_text">لم يتم العثور على منشآت تطابق بحثك. حاول تغيير الفلاتر.</p>
            </div>
            <div id="establishments-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>
             <div id="main-map-section" class="mt-10 bg-white p-4 rounded-xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                    <h2 id="main-map-section-title" class="text-xl sm:text-2xl font-bold text-gray-800 text-center sm:text-right"> 
                        <i class="fas fa-map-marked-alt text-indigo-600"></i> <span data-translate-key="interactive_map_title" class="mr-2 ml-2">الخريطة التفاعلية</span>
                    </h2>
                    <button id="locate-user-btn" class="btn-secondary text-sm py-2 px-3 w-full sm:w-auto"> 
                        <i class="fas fa-location-arrow"></i> <span data-translate-content="true" data-translate-key="locate_user_btn_map">تحديد موقعي على الخريطة</span>
                    </button>
                </div>
                <div id="main-map-container" class="w-full h-80 sm:h-96 md:h-[500px] rounded-lg border border-gray-300 bg-gray-100">
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center" data-translate-key="map_permission_note">قد يطلب المتصفح الإذن للوصول إلى موقعك لعرضه على الخريطة.</p>
            </div>
        </main>
    </div>

    <div id="manage-paid-ads-modal" class="modal-container hidden">
        <div class="modal-content max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800" data-translate-key="manage_paid_ads_modal_title">إدارة الإعلانات المدفوعة</h2>
            <form id="manage-paid-ads-form" class="space-y-5">
                <div>
                    <label for="paid-ad-establishment-id" class="label-text" data-translate-key="establishment_id_label">معرّف المنشأة (ID):</label>
                    <input type="text" id="paid-ad-establishment-id" required data-translate-placeholder="establishment_id_placeholder" placeholder="أدخل ID المنشأة لتفعيل/إلغاء الإعلان" class="input-field">
                    <p class="text-xs text-gray-500 mt-1" data-translate-key="establishment_id_note">يمكنك الحصول على ID المنشأة من لوحة تحكم Firebase.</p>
                </div>
                <div id="manage-paid-ads-feedback"></div> 
                <div class="flex flex-col-reverse sm:flex-row items-center justify-end gap-3 pt-4 border-t mt-6"> 
                    <button type="button" data-close-modal="manage-paid-ads-modal" class="btn-secondary w-full sm:w-auto" data-translate-key="cancel_btn">إلغاء</button>
                    <button type="submit" class="btn-primary bg-teal-500 hover:bg-teal-600 focus:ring-teal-500 w-full sm:w-auto" data-translate-key="toggle_ad_status_btn">تبديل حالة الإعلان</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center p-8 mt-16">
        <p class="text-lg font-semibold" data-translate-key="footer_copyright">&copy; ${new Date().getFullYear()} دليلك. جميع الحقوق محفوظة.</p>
        <p class="text-sm mt-1 opacity-75" data-translate-key="footer_tagline">بوابتك إلى روائع سوريا</p>
    </footer>

</body>
</html>
